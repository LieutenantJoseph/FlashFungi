<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Fungi - Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="/components/training/ModuleLoader.js"></script>
    <style>
        /* Deep Ocean Dark Theme */
        body {
            background-color: #0F1419;
        }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .skeleton { 
            background: linear-gradient(90deg, #1A2332 25%, #263244 50%, #1A2332 75%); 
            background-size: 200% 100%; 
            animation: loading 1.5s infinite; 
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Deep Ocean Blue Gradients */
        .ocean-gradient { 
            background: linear-gradient(135deg, #1E3A5F 0%, #0D2137 100%); 
        }
        
        .sky-gradient {
            background: linear-gradient(135deg, #2563EB 0%, #1E40AF 100%);
        }
        
        .teal-gradient {
            background: linear-gradient(135deg, #0891B2 0%, #0E7490 100%);
        }

        .slate-gradient {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
        }
        
        /* Card styling */
        .card-dark {
            background-color: #1A2332;
            border: 1px solid #263244;
        }
        
        /* Button transitions */
        button {
            transition: all 0.3s ease;
        }
        
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0F1419;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        
        /* Input styling for dark theme */
        input, textarea, select {
            background-color: #0F1419;
            border: 1px solid #263244;
            color: #E2E8F0;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #2563EB;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Modal backdrop blur */
        .modal-backdrop {
            backdrop-filter: blur(8px);
        }
        
        @keyframes shimmer { 
            0% { background-position: 0% 50%; } 
            100% { background-position: 100% 50%; } 
        }
    </style>
</head>
<body>
    <div id="admin-root">
        <div class="min-h-screen bg-[#0F1419] flex items-center justify-center">
            <div class="text-center">
                <div class="text-6xl mb-4">üçÑ</div>
                <h1 class="text-2xl font-bold text-[#E2E8F0] mb-2">Admin Portal Loading...</h1>
                <p class="text-[#94A3B8]">Initializing Flash Fungi management system...</p>
            </div>
        </div>
    </div>

    <!-- Main Admin Portal Script -->
    <script>
        // Wait for React to load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeAdminPortal, 100);
        });

        function initializeAdminPortal() {
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                console.error('React libraries not loaded');
                return;
            }

            const { useState, useEffect, useCallback, useMemo, useRef } = React;
            const h = React.createElement;
            
            // Configuration
            const SUPABASE_URL = 'https://oxgedcncrettasrbmwsl.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94Z2VkY25jcmV0dGFzcmJtd3NsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MDY4NjQsImV4cCI6MjA2OTQ4Mjg2NH0.mu0Cb6qRr4cja0vsSzIuLwDTtNFuimWUwNs_JbnO3Pg';
            const API_BASE = '/api';

            // Utility Functions
            const debounce = (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            };

            // Phase 3 Badge Component
            function Phase3Badge() {
                return h('span', {
                    className: 'px-2 py-1 text-xs font-semibold rounded-full bg-blue-900 bg-opacity-30 text-blue-400 border border-blue-700'
                }, 'Phase 3');
            }

            // ============= ENHANCED PAGINATION COMPONENTS =============
            
            // Pagination Controls Component
            window.PaginationControls = function PaginationControls({ 
                currentPage, 
                totalPages, 
                onPageChange,
                itemsPerPage,
                totalItems,
                onItemsPerPageChange 
            }) {
                // Calculate page range to display
                const getPageRange = () => {
                    const delta = 2;
                    const range = [];
                    const rangeWithDots = [];
                    let l;

                    for (let i = 1; i <= totalPages; i++) {
                        if (i === 1 || i === totalPages || (i >= currentPage - delta && i <= currentPage + delta)) {
                            range.push(i);
                        }
                    }

                    range.forEach((i) => {
                        if (l) {
                            if (i - l === 2) {
                                rangeWithDots.push(l + 1);
                            } else if (i - l !== 1) {
                                rangeWithDots.push('...');
                            }
                        }
                        rangeWithDots.push(i);
                        l = i;
                    });

                    return rangeWithDots;
                };

                const startItem = (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, totalItems);

                return h('div', { className: 'flex flex-col sm:flex-row justify-between items-center gap-4 p-4 bg-[#0F1419] rounded-lg border border-[#263244]' },
                    // Items per page selector
                    h('div', { className: 'flex items-center gap-2' },
                        h('label', { className: 'text-sm text-[#94A3B8]' }, 'Show:'),
                        h('select', {
                            value: itemsPerPage,
                            onChange: (e) => onItemsPerPageChange(Number(e.target.value)),
                            className: 'px-3 py-1 rounded-md text-sm text-[#E2E8F0] bg-[#0F1419] border border-[#263244] focus:border-[#2563EB]'
                        },
                            [10, 25, 50, 100].map(num => 
                                h('option', { key: num, value: num }, `${num} items`)
                            )
                        )
                    ),

                    // Page info
                    h('div', { className: 'text-sm text-[#94A3B8]' },
                        `Showing ${startItem}-${endItem} of ${totalItems} items`
                    ),

                    // Page navigation
                    h('div', { className: 'flex items-center gap-1' },
                        // Previous button
                        h('button', {
                            onClick: () => onPageChange(currentPage - 1),
                            disabled: currentPage === 1,
                            className: `px-3 py-1 rounded-md text-sm ${
                                currentPage === 1 
                                    ? 'bg-[#1A2332] text-[#475569] cursor-not-allowed' 
                                    : 'bg-[#1A2332] text-[#94A3B8] hover:bg-[#263244] border border-[#263244]'
                            }`
                        }, '‚Üê Previous'),

                        // Page numbers
                        ...getPageRange().map((page, idx) => 
                            page === '...' 
                                ? h('span', { key: `dots-${idx}`, className: 'px-2 text-[#475569]' }, '...')
                                : h('button', {
                                    key: page,
                                    onClick: () => onPageChange(page),
                                    className: `px-3 py-1 rounded-md text-sm ${
                                        page === currentPage 
                                            ? 'bg-[#2563EB] text-[#E2E8F0]' 
                                            : 'bg-[#1A2332] text-[#94A3B8] hover:bg-[#263244] border border-[#263244]'
                                    }`
                                }, page)
                        ),

                        // Next button
                        h('button', {
                            onClick: () => onPageChange(currentPage + 1),
                            disabled: currentPage === totalPages,
                            className: `px-3 py-1 rounded-md text-sm ${
                                currentPage === totalPages 
                                    ? 'bg-[#1A2332] text-[#475569] cursor-not-allowed' 
                                    : 'bg-[#1A2332] text-[#94A3B8] hover:bg-[#263244] border border-[#263244]'
                            }`
                        }, 'Next ‚Üí')
                    )
                );
            };

            // Advanced Search Bar Component
            window.AdvancedSearchBar = function AdvancedSearchBar({ 
                value, 
                onChange, 
                placeholder,
                onSearch,
                showAdvanced = false 
            }) {
                const [localValue, setLocalValue] = useState(value);
                const [isAdvancedOpen, setIsAdvancedOpen] = useState(false);
                const timeoutRef = useRef(null);

                // Debounce search
                useEffect(() => {
                    if (timeoutRef.current) clearTimeout(timeoutRef.current);
                    
                    timeoutRef.current = setTimeout(() => {
                        if (localValue !== value) {
                            onChange(localValue);
                            if (onSearch) onSearch(localValue);
                        }
                    }, 300);

                    return () => {
                        if (timeoutRef.current) clearTimeout(timeoutRef.current);
                    };
                }, [localValue]);

                return h('div', { className: 'relative w-full' },
                    h('div', { className: 'relative' },
                        h('input', {
                            type: 'text',
                            value: localValue,
                            onChange: (e) => setLocalValue(e.target.value),
                            placeholder: placeholder || 'Search...',
                            className: 'w-full px-4 py-2 pr-10 bg-[#0F1419] border border-[#263244] text-[#E2E8F0] rounded-lg focus:border-[#2563EB]'
                        }),
                        h('svg', {
                            className: 'absolute right-3 top-2.5 w-5 h-5 text-[#475569]',
                            fill: 'none',
                            stroke: 'currentColor',
                            viewBox: '0 0 24 24'
                        },
                            h('path', {
                                strokeLinecap: 'round',
                                strokeLinejoin: 'round',
                                strokeWidth: 2,
                                d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'
                            })
                        ),
                        showAdvanced && h('button', {
                            onClick: () => setIsAdvancedOpen(!isAdvancedOpen),
                            className: 'absolute right-12 top-2 text-sm text-[#60A5FA] hover:text-[#2563EB]'
                        }, 'Advanced')
                    ),
                    isAdvancedOpen && h('div', {
                        className: 'absolute top-full mt-2 w-full bg-[#1A2332] border border-[#263244] rounded-lg shadow-lg p-4 z-10'
                    },
                        h('div', { className: 'text-sm text-[#94A3B8] mb-2' }, 'Search tips:'),
                        h('ul', { className: 'text-xs text-[#64748B] space-y-1' },
                            h('li', null, '‚Ä¢ Use quotes for exact phrases: "Agaricus bisporus"'),
                            h('li', null, '‚Ä¢ Use OR for multiple terms: edible OR choice'),
                            h('li', null, '‚Ä¢ Use - to exclude: mushroom -poisonous'),
                            h('li', null, '‚Ä¢ Search by field: genus:Amanita family:Agaricaceae')
                        )
                    )
                );
            };

            // Filter Panel Component
            window.FilterPanel = function FilterPanel({ filters, onFilterChange, children, isOpen: initialOpen = false }) {
                const [isOpen, setIsOpen] = useState(initialOpen);
                const activeFilterCount = Object.values(filters).filter(v => v && v !== 'all').length;

                return h('div', { className: 'card-dark rounded-lg' },
                    h('button', {
                        onClick: () => setIsOpen(!isOpen),
                        className: 'w-full px-4 py-3 flex justify-between items-center hover:bg-[#263244]'
                    },
                        h('div', { className: 'flex items-center gap-2' },
                            h('svg', {
                                className: `w-5 h-5 transform transition-transform text-[#94A3B8] ${isOpen ? 'rotate-90' : ''}`,
                                fill: 'none',
                                stroke: 'currentColor',
                                viewBox: '0 0 24 24'
                            },
                                h('path', {
                                    strokeLinecap: 'round',
                                    strokeLinejoin: 'round',
                                    strokeWidth: 2,
                                    d: 'M9 5l7 7-7 7'
                                })
                            ),
                            h('span', { className: 'font-medium text-[#E2E8F0]' }, 'Filters'),
                            activeFilterCount > 0 && h('span', {
                                className: 'px-2 py-0.5 bg-[#2563EB] bg-opacity-20 text-[#60A5FA] text-xs rounded-full'
                            }, activeFilterCount)
                        ),
                        h('span', { className: 'text-sm text-[#94A3B8]' }, 
                            isOpen ? 'Click to collapse' : 'Click to expand'
                        )
                    ),
                    isOpen && h('div', { className: 'p-4 border-t border-[#263244] space-y-4' }, children)
                );
            };

            // Toast Notification Component
            function Toast({ message, type = 'info', onClose }) {
                useEffect(() => {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }, [onClose]);

                const bgColor = {
                    success: 'sky-gradient',
                    error: 'bg-red-900',
                    warning: 'bg-yellow-900',
                    info: 'teal-gradient'
                }[type];

                return h('div', {
                    className: `fixed bottom-4 right-4 ${bgColor} text-[#E2E8F0] px-6 py-3 rounded-lg shadow-xl z-50 flex items-center gap-3 fade-in`
                },
                    h('span', null, message),
                    h('button', {
                        onClick: onClose,
                        className: 'ml-2 hover:text-white transition-colors'
                    }, '√ó')
                );
            }

            // Module Content Editor Component (Full Version)
            function ModuleEditor({ module, onClose, onSave }) {
                const [content, setContent] = useState(module.content || {
                    introduction: { pages: [] },
                    quiz: { questions: [] }
                });
                const [moduleData, setModuleData] = useState({
                    title: module.title || '',
                    category: module.category || 'foundation',
                    difficulty_level: module.difficulty_level || 'beginner',
                    duration_minutes: module.duration_minutes || 20,
                    published: module.published || false,
                    description: module.description || ''
                });
                const [saving, setSaving] = useState(false);
                const [error, setError] = useState(null);
                
                const handleContentChange = (section, field, value) => {
                    setContent(prev => ({
                        ...prev,
                        [section]: {
                            ...prev[section],
                            [field]: value
                        }
                    }));
                };
                
                const handleAddPage = (section) => {
                    setContent(prev => ({
                        ...prev,
                        [section]: {
                            ...prev[section],
                            pages: [...(prev[section]?.pages || []), {
                                title: '',
                                content: '',
                                image: ''
                            }]
                        }
                    }));
                };

                const handleUpdatePage = (section, pageIdx, field, value) => {
                    setContent(prev => ({
                        ...prev,
                        [section]: {
                            ...prev[section],
                            pages: prev[section].pages.map((page, idx) => 
                                idx === pageIdx ? { ...page, [field]: value } : page
                            )
                        }
                    }));
                };

                const handleDeletePage = (section, idx) => {
                    setContent(prev => ({
                        ...prev,
                        [section]: {
                            ...prev[section],
                            pages: prev[section].pages.filter((_, i) => i !== idx)
                        }
                    }));
                };

                const handleAddQuestion = (section) => {
                    setContent(prev => ({
                        ...prev,
                        [section]: {
                            ...prev[section],
                            questions: [...(prev[section]?.questions || []), {
                                question: '',
                                options: ['', '', '', ''],
                                correct: 0,
                                explanation: ''
                            }]
                        }
                    }));
                };

                const handleUpdateQuestion = (section, qIdx, field, value) => {
                    setContent(prev => ({
                        ...prev,
                        [section]: {
                            ...prev[section],
                            questions: prev[section].questions.map((q, idx) => 
                                idx === qIdx ? { ...q, [field]: value } : q
                            )
                        }
                    }));
                };

                const handleDeleteQuestion = (section, idx) => {
                    setContent(prev => ({
                        ...prev,
                        [section]: {
                            ...prev[section],
                            questions: prev[section].questions.filter((_, i) => i !== idx)
                        }
                    }));
                };
                
                const handleSave = async () => {
                    setSaving(true);
                    setError(null);
                    
                    try {
                        const endpoint = module.id 
                            ? `/api/training-modules?id=${module.id}`
                            : '/api/training-modules';
                        
                        const method = module.id ? 'PATCH' : 'POST';
                        
                        const body = module.id 
                            ? { ...moduleData, content }
                            : { 
                                id: `${moduleData.category}_${Date.now()}`,
                                ...moduleData,
                                content
                            };
                        
                        const response = await fetch(endpoint, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            onSave(result.module);
                            onClose();
                        } else {
                            throw new Error(result.error || 'Failed to save module');
                        }
                    } catch (error) {
                        console.error('Error saving module:', error);
                        setError(error.message);
                    } finally {
                        setSaving(false);
                    }
                };
                
                return h('div', {
                    className: 'fixed inset-0 bg-black bg-opacity-75 modal-backdrop flex items-center justify-center p-4 z-50 overflow-y-auto'
                },
                    h('div', {
                        className: 'card-dark rounded-xl max-w-5xl w-full my-8 max-h-[90vh] overflow-hidden flex flex-col shadow-2xl'
                    },
                        // Header
                        h('div', {
                            className: 'ocean-gradient text-[#E2E8F0] p-6 rounded-t-xl flex-shrink-0'
                        },
                            h('div', { className: 'flex justify-between items-start' },
                                h('div', null,
                                    h('h2', { className: 'text-2xl font-bold mb-2' }, 
                                        module.id ? `Edit: ${moduleData.title}` : 'Create New Module'
                                    ),
                                    h('div', { className: 'flex gap-4 text-sm opacity-90' },
                                        h('span', null, `${moduleData.category} ‚Ä¢ ${moduleData.difficulty_level}`),
                                        h('span', null, `${moduleData.duration_minutes} minutes`)
                                    )
                                ),
                                h('button', {
                                    onClick: onClose,
                                    className: 'text-white hover:text-gray-200 text-2xl'
                                }, '√ó')
                            )
                        ),
                        
                        // Module Settings
                        h('div', { className: 'p-6 bg-[#0F1419] border-b border-[#263244] flex-shrink-0' },
                            h('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-[#94A3B8] mb-1' }, 'Title'),
                                    h('input', {
                                        type: 'text',
                                        value: moduleData.title,
                                        onChange: (e) => setModuleData(prev => ({ ...prev, title: e.target.value })),
                                        className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]',
                                        placeholder: 'Module title...'
                                    })
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-[#94A3B8] mb-1' }, 'Category'),
                                    h('select', {
                                        value: moduleData.category,
                                        onChange: (e) => setModuleData(prev => ({ ...prev, category: e.target.value })),
                                        className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]'
                                    },
                                        h('option', { value: 'foundation' }, 'Foundation'),
                                        h('option', { value: 'genus' }, 'Genus-Specific'),
                                        h('option', { value: 'advanced' }, 'Advanced'),
                                        h('option', { value: 'regional' }, 'Regional')
                                    )
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-[#94A3B8] mb-1' }, 'Difficulty'),
                                    h('select', {
                                        value: moduleData.difficulty_level,
                                        onChange: (e) => setModuleData(prev => ({ ...prev, difficulty_level: e.target.value })),
                                        className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]'
                                    },
                                        h('option', { value: 'beginner' }, 'Beginner'),
                                        h('option', { value: 'intermediate' }, 'Intermediate'),
                                        h('option', { value: 'advanced' }, 'Advanced')
                                    )
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium text-[#94A3B8] mb-1' }, 'Duration (min)'),
                                    h('input', {
                                        type: 'number',
                                        value: moduleData.duration_minutes,
                                        onChange: (e) => setModuleData(prev => ({ ...prev, duration_minutes: parseInt(e.target.value) })),
                                        className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]',
                                        min: 5,
                                        max: 60
                                    })
                                )
                            ),
                            h('div', { className: 'mt-4' },
                                h('label', { className: 'block text-sm font-medium text-[#94A3B8] mb-1' }, 'Description'),
                                h('textarea', {
                                    value: moduleData.description,
                                    onChange: (e) => setModuleData(prev => ({ ...prev, description: e.target.value })),
                                    placeholder: 'Module description...',
                                    className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]',
                                    rows: 2
                                })
                            ),
                            h('div', { className: 'mt-4 flex items-center' },
                                h('label', { className: 'flex items-center cursor-pointer' },
                                    h('input', {
                                        type: 'checkbox',
                                        checked: moduleData.published,
                                        onChange: (e) => setModuleData(prev => ({ ...prev, published: e.target.checked })),
                                        className: 'mr-2'
                                    }),
                                    h('span', { className: 'text-sm font-medium text-[#94A3B8]' }, 'Published (visible to users)')
                                )
                            )
                        ),
                        
                        // Content Editor (scrollable)
                        h('div', {
                            className: 'flex-1 overflow-y-auto p-6'
                        },
                            // Error display
                            error && h('div', { 
                                className: 'mb-4 p-3 bg-red-900 bg-opacity-50 border border-red-700 text-red-300 rounded-lg' 
                            }, error),

                            // Introduction Section
                            h('div', { className: 'mb-8' },
                                h('h3', { className: 'text-lg font-semibold mb-3 flex items-center text-[#E2E8F0]' }, 
                                    h('span', { className: 'mr-2' }, 'üìñ'),
                                    'Introduction Pages'
                                ),
                                h('div', { className: 'space-y-4' },
                                    (content.introduction?.pages || []).map((page, idx) =>
                                        h('div', {
                                            key: idx,
                                            className: 'bg-[#0F1419] border border-[#263244] rounded-lg p-4'
                                        },
                                            h('div', { className: 'flex justify-between items-start mb-3' },
                                                h('span', { className: 'text-sm font-medium text-[#94A3B8]' }, 
                                                    `Page ${idx + 1}`
                                                ),
                                                h('button', {
                                                    onClick: () => handleDeletePage('introduction', idx),
                                                    className: 'text-red-400 hover:text-red-300 text-sm'
                                                }, 'Delete')
                                            ),
                                            h('input', {
                                                type: 'text',
                                                value: page.title || '',
                                                onChange: (e) => handleUpdatePage('introduction', idx, 'title', e.target.value),
                                                placeholder: 'Page title...',
                                                className: 'w-full px-3 py-2 rounded text-sm mb-2 text-[#E2E8F0]'
                                            }),
                                            h('textarea', {
                                                value: page.content || '',
                                                onChange: (e) => handleUpdatePage('introduction', idx, 'content', e.target.value),
                                                placeholder: 'Page content...',
                                                className: 'w-full px-3 py-2 rounded text-sm text-[#E2E8F0]',
                                                rows: 4
                                            }),
                                            h('input', {
                                                type: 'text',
                                                value: page.image || '',
                                                onChange: (e) => handleUpdatePage('introduction', idx, 'image', e.target.value),
                                                placeholder: 'Image URL (optional)...',
                                                className: 'w-full px-3 py-2 rounded text-sm mt-2 text-[#E2E8F0]'
                                            })
                                        )
                                    ),
                                    h('button', {
                                        onClick: () => handleAddPage('introduction'),
                                        className: 'w-full py-2 border-2 border-dashed border-[#263244] rounded-lg text-[#94A3B8] hover:border-[#2563EB] hover:text-[#60A5FA] transition-all'
                                    }, '+ Add Page')
                                )
                            ),

                            // Quiz Section
                            h('div', { className: 'mb-8' },
                                h('h3', { className: 'text-lg font-semibold mb-3 flex items-center text-[#E2E8F0]' }, 
                                    h('span', { className: 'mr-2' }, '‚ùì'),
                                    'Quiz Questions'
                                ),
                                h('div', { className: 'space-y-4' },
                                    (content.quiz?.questions || []).map((question, idx) =>
                                        h('div', {
                                            key: idx,
                                            className: 'bg-[#0F1419] border border-[#263244] rounded-lg p-4'
                                        },
                                            h('div', { className: 'flex justify-between items-start mb-3' },
                                                h('span', { className: 'text-sm font-medium text-[#94A3B8]' }, 
                                                    `Question ${idx + 1}`
                                                ),
                                                h('button', {
                                                    onClick: () => handleDeleteQuestion('quiz', idx),
                                                    className: 'text-red-400 hover:text-red-300 text-sm'
                                                }, 'Delete')
                                            ),
                                            h('input', {
                                                type: 'text',
                                                value: question.question || '',
                                                onChange: (e) => handleUpdateQuestion('quiz', idx, 'question', e.target.value),
                                                placeholder: 'Question text...',
                                                className: 'w-full px-3 py-2 rounded-lg text-sm mb-3 text-[#E2E8F0]'
                                            }),
                                            h('div', { className: 'space-y-2' },
                                                (question.options || ['', '', '', '']).map((option, optIdx) =>
                                                    h('div', { key: optIdx, className: 'flex items-center gap-2' },
                                                        h('input', {
                                                            type: 'radio',
                                                            name: `correct-${idx}`,
                                                            checked: question.correct === optIdx,
                                                            onChange: () => handleUpdateQuestion('quiz', idx, 'correct', optIdx),
                                                            className: 'flex-shrink-0'
                                                        }),
                                                        h('input', {
                                                            type: 'text',
                                                            value: option,
                                                            onChange: (e) => {
                                                                const newOptions = [...question.options];
                                                                newOptions[optIdx] = e.target.value;
                                                                handleUpdateQuestion('quiz', idx, 'options', newOptions);
                                                            },
                                                            placeholder: `Option ${optIdx + 1}...`,
                                                            className: 'flex-1 px-3 py-1 rounded text-sm text-[#E2E8F0]'
                                                        })
                                                    )
                                                )
                                            ),
                                            h('textarea', {
                                                value: question.explanation || '',
                                                onChange: (e) => handleUpdateQuestion('quiz', idx, 'explanation', e.target.value),
                                                placeholder: 'Explanation (shown after answer)...',
                                                className: 'w-full px-3 py-2 rounded-lg text-sm mt-3 text-[#E2E8F0]',
                                                rows: 2
                                            })
                                        )
                                    ),
                                    h('button', {
                                        onClick: () => handleAddQuestion('quiz'),
                                        className: 'w-full py-2 border-2 border-dashed border-[#263244] rounded-lg text-[#94A3B8] hover:border-[#2563EB] hover:text-[#60A5FA] transition-all'
                                    }, '+ Add Question')
                                )
                            )
                        ),
                        
                        // Footer
                        h('div', {
                            className: 'p-6 bg-[#0F1419] border-t border-[#263244] flex justify-between items-center flex-shrink-0'
                        },
                            h('button', {
                                onClick: onClose,
                                className: 'px-6 py-2 border border-[#263244] text-[#94A3B8] rounded-lg hover:bg-[#263244] transition-all'
                            }, 'Cancel'),
                            h('button', {
                                onClick: handleSave,
                                disabled: saving || !moduleData.title,
                                className: `px-6 py-2 sky-gradient text-[#E2E8F0] rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all ${
                                    saving ? 'cursor-wait' : ''
                                }`
                            }, saving ? 'Saving...' : 'Save Module')
                        )
                    )
                );
            }

            // Field Guide Editor Component (Full Version)
            function FieldGuideEditor({ species, specimens, allPhotos, onClose, onSave }) {
                // Initialize state with existing field guide data or defaults
                const [fieldGuide, setFieldGuide] = useState({
                    species_name: species.species_name,
                    description: species.description || '',
                    ecology: species.ecology || '',
                    reference_photos: species.reference_photos || [],
                    hints: species.hints || [
                        { type: 'morphological', level: 1, text: '' },
                        { type: 'comparative', level: 2, text: '' },
                        { type: 'ecological', level: 3, text: '' },
                        { type: 'taxonomic', level: 4, text: '' }
                    ],
                    diagnostic_features: species.diagnostic_features || {
                        cap: { shape: '', color: '', texture: '', size_range: '' },
                        gills_pores: { type: '', attachment: '', spacing: '', color: '' },
                        stem: { ring_presence: '', base_structure: '', texture: '' },
                        spore_print: { color: '', collection_method: '' },
                        chemical_reactions: { tests: [] }
                    },
                    comparison_species: species.comparison_species || []
                });

                const [activeTab, setActiveTab] = useState('overview');
                const [photoSelector, setPhotoSelector] = useState(false);
                const [customUrl, setCustomUrl] = useState('');
                const [saving, setSaving] = useState(false);

                // Get specimens of this species
                const speciesSpecimens = specimens.filter(s => s.species_name === species.species_name);
                const dnaVerifiedCount = speciesSpecimens.filter(s => s.dna_sequenced).length;

                // Handle photo selection
                const handleAddPhoto = (photo) => {
                    if (fieldGuide.reference_photos.length < 6) {
                        setFieldGuide(prev => ({
                            ...prev,
                            reference_photos: [...prev.reference_photos, photo]
                        }));
                    }
                };

                const handleRemovePhoto = (index) => {
                    setFieldGuide(prev => ({
                        ...prev,
                        reference_photos: prev.reference_photos.filter((_, i) => i !== index)
                    }));
                };

                const handleAddCustomUrl = () => {
                    if (customUrl && fieldGuide.reference_photos.length < 6) {
                        handleAddPhoto({
                            type: 'external',
                            url: customUrl,
                            source: 'Custom URL'
                        });
                        setCustomUrl('');
                    }
                };

                // Update hint
                const updateHint = (index, text) => {
                    const newHints = [...fieldGuide.hints];
                    newHints[index] = { ...newHints[index], text };
                    setFieldGuide(prev => ({ ...prev, hints: newHints }));
                };

                // Update diagnostic features
                const updateDiagnostic = (category, field, value) => {
                    setFieldGuide(prev => ({
                        ...prev,
                        diagnostic_features: {
                            ...prev.diagnostic_features,
                            [category]: {
                                ...prev.diagnostic_features[category],
                                [field]: value
                            }
                        }
                    }));
                };

                // Save field guide
                const handleSave = async () => {
                    setSaving(true);
                    try {
                        // Check if field guide exists
                        const checkResponse = await fetch(
                            `${SUPABASE_URL}/rest/v1/field_guides?species_name=eq.${encodeURIComponent(species.species_name)}`,
                            {
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                }
                            }
                        );

                        const existing = await checkResponse.json();
                        const method = existing.length > 0 ? 'PATCH' : 'POST';
                        const url = existing.length > 0 
                            ? `${SUPABASE_URL}/rest/v1/field_guides?species_name=eq.${encodeURIComponent(species.species_name)}`
                            : `${SUPABASE_URL}/rest/v1/field_guides`;

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(fieldGuide)
                        });

                        if (response.ok) {
                            onSave(fieldGuide);
                            onClose();
                        } else {
                            throw new Error('Failed to save field guide');
                        }
                    } catch (error) {
                        console.error('Error saving field guide:', error);
                    } finally {
                        setSaving(false);
                    }
                };

                return h('div', { className: 'fixed inset-0 bg-black bg-opacity-75 modal-backdrop flex items-center justify-center p-4 z-50' },
                    h('div', { className: 'card-dark rounded-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-2xl' },
                        // Header
                        h('div', { className: 'sky-gradient text-[#E2E8F0] p-6' },
                            h('div', { className: 'flex justify-between items-start' },
                                h('div', null,
                                    h('h2', { className: 'text-2xl font-bold mb-2' }, 
                                        `Field Guide: ${species.species_name}`
                                    ),
                                    h('div', { className: 'flex gap-4 text-sm opacity-90' },
                                        h('span', null, `${speciesSpecimens.length} specimens`),
                                        dnaVerifiedCount > 0 && h('span', null, `${dnaVerifiedCount} DNA verified`),
                                        h('span', null, `Family: ${species.family || 'Unknown'}`)
                                    )
                                ),
                                h('button', {
                                    onClick: onClose,
                                    className: 'text-white hover:text-gray-200 text-2xl'
                                }, '√ó')
                            )
                        ),

                        // Tabs
                        h('div', { className: 'border-b border-[#263244] bg-[#0F1419]' },
                            h('div', { className: 'flex gap-4 px-6' },
                                ['overview', 'photos', 'diagnostic', 'hints', 'comparison'].map(tab =>
                                    h('button', {
                                        key: tab,
                                        onClick: () => setActiveTab(tab),
                                        className: `py-3 px-4 border-b-2 transition-colors capitalize ${
                                            activeTab === tab 
                                                ? 'border-[#2563EB] text-[#60A5FA] font-medium' 
                                                : 'border-transparent text-[#94A3B8] hover:text-[#E2E8F0]'
                                        }`
                                    }, tab === 'photos' ? 'üì∏ Photos' : tab)
                                )
                            )
                        ),

                        // Content
                        h('div', { className: 'flex-1 overflow-y-auto p-6 bg-[#1A2332]' },
                            // Overview Tab
                            activeTab === 'overview' && h('div', { className: 'space-y-6' },
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium mb-2 text-[#94A3B8]' }, 'Description'),
                                    h('textarea', {
                                        value: fieldGuide.description,
                                        onChange: (e) => setFieldGuide(prev => ({ ...prev, description: e.target.value })),
                                        placeholder: 'Comprehensive species description...',
                                        className: 'w-full p-3 rounded-lg text-[#E2E8F0]',
                                        rows: 6
                                    })
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-medium mb-2 text-[#94A3B8]' }, 'Ecology & Habitat'),
                                    h('textarea', {
                                        value: fieldGuide.ecology,
                                        onChange: (e) => setFieldGuide(prev => ({ ...prev, ecology: e.target.value })),
                                        placeholder: 'Habitat, substrate, seasonal patterns, geographic distribution...',
                                        className: 'w-full p-3 rounded-lg text-[#E2E8F0]',
                                        rows: 4
                                    })
                                )
                            ),

                            // Photos Tab
                            activeTab === 'photos' && h('div', { className: 'space-y-6' },
                                h('div', { className: 'flex justify-between items-center mb-4' },
                                    h('h3', { className: 'text-lg font-semibold text-[#E2E8F0]' }, 
                                        `Reference Photos (${fieldGuide.reference_photos.length}/6)`
                                    ),
                                    h('button', {
                                        onClick: () => setPhotoSelector(!photoSelector),
                                        disabled: fieldGuide.reference_photos.length >= 6,
                                        className: `px-4 py-2 teal-gradient text-[#E2E8F0] rounded-lg hover:opacity-90 disabled:opacity-50 transition-all ${
                                            fieldGuide.reference_photos.length >= 6 ? 'cursor-not-allowed' : ''
                                        }`
                                    }, '+ Add Photo')
                                ),

                                // Selected Photos
                                fieldGuide.reference_photos.length > 0 ?
                                    h('div', { className: 'grid grid-cols-3 gap-4' },
                                        fieldGuide.reference_photos.map((photo, idx) =>
                                            h('div', { key: idx, className: 'relative border border-[#263244] rounded-lg overflow-hidden' },
                                                h('img', {
                                                    src: photo.url,
                                                    alt: `Reference ${idx + 1}`,
                                                    className: 'w-full h-48 object-cover'
                                                }),
                                                h('div', { className: 'absolute top-2 right-2' },
                                                    h('button', {
                                                        onClick: () => handleRemovePhoto(idx),
                                                        className: 'bg-red-500 text-white rounded-full p-1 hover:bg-red-600'
                                                    }, '√ó')
                                                ),
                                                h('div', { className: 'p-2 bg-[#0F1419]' },
                                                    h('p', { className: 'text-xs text-[#94A3B8]' }, photo.source),
                                                    photo.inaturalist_id && h('a', {
                                                        href: `https://www.inaturalist.org/observations/${photo.inaturalist_id}`,
                                                        target: '_blank',
                                                        className: 'text-xs text-[#60A5FA] hover:underline'
                                                    }, 'View on iNaturalist ‚Üí')
                                                )
                                            )
                                        )
                                    ) :
                                    h('div', { className: 'text-center py-8 bg-[#0F1419] rounded-lg' },
                                        h('p', { className: 'text-[#94A3B8]' }, 'No reference photos selected')
                                    ),

                                // Photo Selector
                                photoSelector && h('div', { className: 'border-t border-[#263244] pt-4 mt-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E2E8F0]' }, 'Add Reference Photo'),
                                    
                                    // Custom URL Input
                                    h('div', { className: 'mb-4' },
                                        h('label', { className: 'block text-sm font-medium mb-2 text-[#94A3B8]' }, 'External URL'),
                                        h('div', { className: 'flex gap-2' },
                                            h('input', {
                                                type: 'url',
                                                value: customUrl,
                                                onChange: (e) => setCustomUrl(e.target.value),
                                                placeholder: 'https://example.com/mushroom.jpg',
                                                className: 'flex-1 px-3 py-2 rounded-lg text-[#E2E8F0]'
                                            }),
                                            h('button', {
                                                onClick: handleAddCustomUrl,
                                                className: 'px-4 py-2 sky-gradient text-[#E2E8F0] rounded-lg hover:opacity-90 transition-all'
                                            }, 'Add URL')
                                        )
                                    ),

                                    // Specimen Photos
                                    h('div', null,
                                        h('label', { className: 'block text-sm font-medium mb-2 text-[#94A3B8]' }, 
                                            'Or select from specimen photos'
                                        ),
                                        h('div', { className: 'grid grid-cols-4 gap-2 max-h-64 overflow-y-auto' },
                                            allPhotos
                                                .filter(photo => !fieldGuide.reference_photos.some(rp => 
                                                    rp.url === photo.url
                                                ))
                                                .map((photo, idx) =>
                                                    h('div', {
                                                        key: idx,
                                                        onClick: () => handleAddPhoto(photo),
                                                        className: 'cursor-pointer border-2 border-transparent hover:border-[#2563EB] rounded transition-all'
                                                    },
                                                        h('img', {
                                                            src: photo.url,
                                                            alt: `Option ${idx}`,
                                                            className: 'w-full h-24 object-cover rounded'
                                                        })
                                                    )
                                                )
                                        )
                                    )
                                )
                            ),

                            // Diagnostic Features Tab
                            activeTab === 'diagnostic' && h('div', { className: 'space-y-6' },
                                h('h3', { className: 'text-lg font-semibold mb-4 text-[#E2E8F0]' }, 'Diagnostic Features'),
                                
                                // Cap Features
                                h('div', { className: 'bg-[#0F1419] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E2E8F0]' }, 'üçÑ Cap Features'),
                                    h('div', { className: 'grid grid-cols-2 gap-3' },
                                        ['shape', 'color', 'texture', 'size_range'].map(field =>
                                            h('div', { key: field },
                                                h('label', { className: 'block text-sm font-medium mb-1 capitalize text-[#94A3B8]' }, 
                                                    field.replace('_', ' ')
                                                ),
                                                h('input', {
                                                    type: 'text',
                                                    value: fieldGuide.diagnostic_features.cap[field],
                                                    onChange: (e) => updateDiagnostic('cap', field, e.target.value),
                                                    className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]'
                                                })
                                            )
                                        )
                                    )
                                ),

                                // Gills/Pores Features
                                h('div', { className: 'bg-[#0F1419] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E2E8F0]' }, 'üìä Gills/Pores Features'),
                                    h('div', { className: 'grid grid-cols-2 gap-3' },
                                        ['type', 'attachment', 'spacing', 'color'].map(field =>
                                            h('div', { key: field },
                                                h('label', { className: 'block text-sm font-medium mb-1 capitalize text-[#94A3B8]' }, field),
                                                h('input', {
                                                    type: 'text',
                                                    value: fieldGuide.diagnostic_features.gills_pores[field],
                                                    onChange: (e) => updateDiagnostic('gills_pores', field, e.target.value),
                                                    placeholder: field === 'type' ? 'gills/pores/teeth' : '',
                                                    className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]'
                                                })
                                            )
                                        )
                                    )
                                ),

                                // Stem Features
                                h('div', { className: 'bg-[#0F1419] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E2E8F0]' }, 'ü¶¥ Stem Features'),
                                    h('div', { className: 'grid grid-cols-3 gap-3' },
                                        ['ring_presence', 'base_structure', 'texture'].map(field =>
                                            h('div', { key: field },
                                                h('label', { className: 'block text-sm font-medium mb-1 capitalize text-[#94A3B8]' }, 
                                                    field.replace('_', ' ')
                                                ),
                                                h('input', {
                                                    type: 'text',
                                                    value: fieldGuide.diagnostic_features.stem[field],
                                                    onChange: (e) => updateDiagnostic('stem', field, e.target.value),
                                                    className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]'
                                                })
                                            )
                                        )
                                    )
                                ),

                                // Spore Print
                                h('div', { className: 'bg-[#0F1419] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E2E8F0]' }, 'üé® Spore Print'),
                                    h('div', { className: 'grid grid-cols-2 gap-3' },
                                        h('div', null,
                                            h('label', { className: 'block text-sm font-medium mb-1 text-[#94A3B8]' }, 'Color'),
                                            h('input', {
                                                type: 'text',
                                                value: fieldGuide.diagnostic_features.spore_print.color,
                                                onChange: (e) => updateDiagnostic('spore_print', 'color', e.target.value),
                                                className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]'
                                            })
                                        ),
                                        h('div', null,
                                            h('label', { className: 'block text-sm font-medium mb-1 text-[#94A3B8]' }, 'Collection Method'),
                                            h('input', {
                                                type: 'text',
                                                value: fieldGuide.diagnostic_features.spore_print.collection_method,
                                                onChange: (e) => updateDiagnostic('spore_print', 'collection_method', e.target.value),
                                                className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]'
                                            })
                                        )
                                    )
                                )
                            ),

                            // Hints Tab
                            activeTab === 'hints' && h('div', { className: 'space-y-6' },
                                h('h3', { className: 'text-lg font-semibold mb-4 text-[#E2E8F0]' }, 'Progressive Hints'),
                                h('p', { className: 'text-sm text-[#94A3B8] mb-4' }, 
                                    'These hints are revealed progressively when students answer incorrectly.'
                                ),
                                
                                fieldGuide.hints.map((hint, idx) => {
                                    const hintTypes = {
                                        'morphological': { icon: 'üîç', color: 'green', label: 'Morphological (Physical Features)' },
                                        'comparative': { icon: '‚öñÔ∏è', color: 'blue', label: 'Comparative (Similar Species)' },
                                        'ecological': { icon: 'üå≤', color: 'emerald', label: 'Ecological (Habitat/Context)' },
                                        'taxonomic': { icon: 'üìö', color: 'purple', label: 'Taxonomic (Classification)' }
                                    };
                                    const type = hintTypes[hint.type];
                                    
                                    return h('div', { 
                                        key: idx, 
                                        className: `border border-[#263244] rounded-lg p-4 bg-[#0F1419]`
                                    },
                                        h('div', { className: 'flex items-center gap-2 mb-2' },
                                            h('span', { className: 'text-2xl' }, type.icon),
                                            h('span', { className: 'font-medium text-[#E2E8F0]' }, `Level ${hint.level}: ${type.label}`)
                                        ),
                                        h('textarea', {
                                            value: hint.text,
                                            onChange: (e) => updateHint(idx, e.target.value),
                                            placeholder: `Enter ${hint.type} hint...`,
                                            className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E2E8F0]',
                                            rows: 3
                                        })
                                    );
                                })
                            ),

                            // Comparison Tab
                            activeTab === 'comparison' && h('div', { className: 'space-y-6' },
                                h('h3', { className: 'text-lg font-semibold mb-4 text-[#E2E8F0]' }, 'Similar Species & Look-Alikes'),
                                h('p', { className: 'text-sm text-[#94A3B8] mb-4' }, 
                                    'Add species that are commonly confused with this one.'
                                ),
                                h('div', { className: 'bg-yellow-900 bg-opacity-30 border border-yellow-700 rounded-lg p-4' },
                                    h('p', { className: 'text-sm text-yellow-300' }, 
                                        '‚ö†Ô∏è This feature will be expanded in Phase 3 with side-by-side comparisons and safety warnings.'
                                    )
                                )
                            )
                        ),

                        // Footer
                        h('div', { className: 'border-t border-[#263244] p-6 bg-[#0F1419]' },
                            h('div', { className: 'flex justify-between items-center' },
                                h('div', { className: 'text-sm text-[#94A3B8]' },
                                    h('span', null, 
                                        `${fieldGuide.hints.filter(h => h.text).length}/4 hints configured ‚Ä¢ ` +
                                        `${fieldGuide.reference_photos.length}/6 photos`
                                    )
                                ),
                                h('div', { className: 'flex gap-3' },
                                    h('button', {
                                        onClick: onClose,
                                        className: 'px-6 py-2 border border-[#263244] text-[#94A3B8] rounded-lg hover:bg-[#263244] transition-all'
                                    }, 'Cancel'),
                                    h('button', {
                                        onClick: handleSave,
                                        disabled: saving,
                                        className: 'px-6 py-2 sky-gradient text-[#E2E8F0] rounded-lg hover:opacity-90 disabled:opacity-50 transition-all'
                                    }, saving ? 'Saving...' : 'üíæ Save Field Guide')
                                )
                            )
                        )
                    )
                );
            }

            // Specimen Review Modal (Full Version with iNaturalist)
            function SpecimenReviewModal({ specimen, onClose, onApprove, onDelete }) {
                const [notes, setNotes] = useState('');
                const [selectedPhotos, setSelectedPhotos] = useState([]);
                const [photos, setPhotos] = useState([]);
                const [loadingPhotos, setLoadingPhotos] = useState(true);
                const [expandedPhoto, setExpandedPhoto] = useState(null);

                // Load photos from iNaturalist when modal opens
                useEffect(() => {
                    loadPhotos();
                }, []);

                const loadPhotos = async () => {
                    try {
                        console.log('Loading photos for specimen:', specimen.inaturalist_id);
                        
                        // Fetch from iNaturalist API using the observation ID
                        const response = await fetch(
                            `https://api.inaturalist.org/v1/observations/${specimen.inaturalist_id}`
                        );
                        
                        if (!response.ok) {
                            throw new Error('Failed to fetch observation');
                        }
                        
                        const data = await response.json();
                        
                        if (data.results && data.results[0] && data.results[0].photos) {
                            const inatPhotos = data.results[0].photos;
                            console.log('Found photos:', inatPhotos.length);
                            
                            // Convert iNaturalist photo format to our format
                            const photoData = inatPhotos.map(photo => ({
                                id: photo.id,
                                thumb: photo.url.replace('square', 'square'), // square is thumb
                                medium: photo.url.replace('square', 'medium'),
                                large: photo.url.replace('square', 'large'),
                                original: photo.url.replace('square', 'original'),
                                attribution: photo.attribution
                            }));
                            
                            setPhotos(photoData);
                            
                            // If specimen already has selected photos, use those, otherwise select all
                            if (specimen.selected_photos && specimen.selected_photos.length > 0) {
                                setSelectedPhotos(specimen.selected_photos);
                            } else {
                                // Select all photos by default for new reviews
                                setSelectedPhotos(photoData.map(p => p.id));
                            }
                        } else {
                            console.log('No photos found in iNaturalist response');
                            setPhotos([]);
                        }
                    } catch (error) {
                        console.error('Error loading photos:', error);
                        setPhotos([]);
                    } finally {
                        setLoadingPhotos(false);
                    }
                };

                const togglePhotoSelection = (photoId) => {
                    setSelectedPhotos(prev => 
                        prev.includes(photoId) 
                            ? prev.filter(id => id !== photoId)
                            : [...prev, photoId]
                    );
                };
                
                return h('div', { 
                    className: 'fixed inset-0 bg-black bg-opacity-75 modal-backdrop flex items-center justify-center p-4 z-50'
                },
                    h('div', { 
                        className: 'card-dark rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl'
                    },
                        h('div', { className: 'p-6' },
                            // Header
                            h('div', { className: 'flex justify-between items-start mb-4' },
                                h('div', null,
                                    h('h2', { className: 'text-2xl font-bold text-[#E2E8F0]' }, specimen.species_name),
                                    specimen.common_name && h('p', { className: 'text-[#94A3B8]' }, specimen.common_name),
                                    h('div', { className: 'flex gap-4 mt-2 text-sm text-[#64748B]' },
                                        h('span', null, `üìç ${specimen.location}`),
                                        specimen.dna_sequenced && h('span', { className: 'text-purple-400 font-medium' }, 'üß¨ DNA Verified'),
                                        h('span', null, `ID: ${specimen.inaturalist_id}`)
                                    )
                                ),
                                h('button', {
                                    onClick: onClose,
                                    className: 'text-[#94A3B8] hover:text-[#E2E8F0] transition-colors'
                                }, '‚úï')
                            ),
                            
                            // Photos Section
                            h('div', { className: 'mb-6' },
                                h('h3', { className: 'font-semibold mb-3 text-[#E2E8F0]' }, 'Photos (Click to expand, check to select for field guide)'),
                                
                                loadingPhotos ? 
                                    h('div', { className: 'text-center py-8' },
                                        h('div', { className: 'text-[#94A3B8]' }, 'Loading photos from iNaturalist...')
                                    ) :
                                photos.length > 0 ? 
                                    h('div', { className: 'grid grid-cols-4 gap-3' },
                                        photos.map(photo =>
                                            h('div', { 
                                                key: photo.id,
                                                className: 'relative group'
                                            },
                                                h('img', {
                                                    src: photo.thumb,
                                                    alt: `Photo ${photo.id}`,
                                                    className: 'w-full aspect-square object-cover rounded cursor-pointer hover:opacity-90',
                                                    onClick: () => setExpandedPhoto(photo),
                                                    onError: (e) => {
                                                        // Fallback image
                                                        e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjUwIiB5PSI1MCIgc3R5bGU9ImZpbGw6I2FhYTtmb250LXdlaWdodDpib2xkO2ZvbnQtc2l6ZToxMnB4O2ZvbnQtZmFtaWx5OkFyaWFsLEhlbHZldGljYSxzYW5zLXNlcmlmO2RvbWluYW50LWJhc2VsaW5lOmNlbnRyYWwiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
                                                    }
                                                }),
                                                h('input', {
                                                    type: 'checkbox',
                                                    checked: selectedPhotos.includes(photo.id),
                                                    onChange: () => togglePhotoSelection(photo.id),
                                                    className: 'absolute top-2 right-2 w-5 h-5 cursor-pointer'
                                                }),
                                                photo.attribution && h('div', {
                                                    className: 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 opacity-0 group-hover:opacity-100 transition-opacity'
                                                }, photo.attribution)
                                            )
                                        )
                                    ) :
                                    h('p', { className: 'text-[#94A3B8] text-center py-8' }, 
                                        'No photos available for this specimen. Check iNaturalist ID: ' + specimen.inaturalist_id
                                    )
                            ),
                            
                            // Details Section
                            h('div', { className: 'grid grid-cols-2 gap-4 mb-6' },
                                h('div', null,
                                    h('h3', { className: 'font-semibold mb-2 text-[#E2E8F0]' }, 'Taxonomic Info'),
                                    h('div', { className: 'space-y-1 text-sm text-[#94A3B8]' },
                                        h('p', null, `Genus: ${specimen.genus || 'Unknown'}`),
                                        h('p', null, `Family: ${specimen.family || 'Unknown'}`),
                                        h('p', null, `Quality Score: ${specimen.quality_score ? (specimen.quality_score * 100).toFixed(0) + '%' : 'N/A'}`)
                                    )
                                ),
                                h('div', null,
                                    h('h3', { className: 'font-semibold mb-2 text-[#E2E8F0]' }, 'Description'),
                                    h('p', { className: 'text-sm text-[#94A3B8]' }, specimen.description || 'No description available')
                                )
                            ),
                            
                            // Admin Notes
                            h('div', { className: 'mb-6' },
                                h('label', { className: 'block font-semibold mb-2 text-[#E2E8F0]' }, 'Admin Notes'),
                                h('textarea', {
                                    value: notes,
                                    onChange: (e) => setNotes(e.target.value),
                                    className: 'w-full p-3 rounded-lg text-[#E2E8F0]',
                                    rows: 3,
                                    placeholder: 'Add notes about this specimen...'
                                })
                            ),
                            
                            // Actions
                            h('div', { className: 'flex justify-between items-center pt-4 border-t border-[#263244]' },
                                h('div', { className: 'text-sm text-[#64748B]' },
                                    loadingPhotos ? 'Loading photos...' :
                                    `Status: ${specimen.status} | ${selectedPhotos.length} of ${photos.length} photos selected`
                                ),
                                h('div', { className: 'flex gap-3' },
                                    specimen.status === 'pending' && [
                                        h('button', {
                                            key: 'delete',
                                            onClick: () => onDelete(),
                                            className: 'px-6 py-2 bg-red-900 text-[#E2E8F0] rounded-lg hover:bg-red-800 transition-all'
                                        }, 'üóëÔ∏è Delete'),
                                        h('button', {
                                            key: 'approve',
                                            onClick: () => onApprove(notes, selectedPhotos),
                                            disabled: loadingPhotos || selectedPhotos.length === 0,
                                            className: `px-6 py-2 rounded-lg transition-all ${
                                                loadingPhotos || selectedPhotos.length === 0 
                                                    ? 'bg-gray-700 cursor-not-allowed text-gray-500' 
                                                    : 'sky-gradient text-[#E2E8F0] hover:opacity-90'
                                            }`
                                        }, '‚úÖ Approve')
                                    ],
                                    h('button', {
                                        onClick: onClose,
                                        className: 'px-6 py-2 border border-[#263244] text-[#94A3B8] rounded-lg hover:bg-[#263244] transition-all'
                                    }, 'Close')
                                )
                            )
                        ),
                        
                        // Photo Expansion Modal
                        expandedPhoto && h('div', {
                            className: 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-60',
                            onClick: () => setExpandedPhoto(null)
                        },
                            h('div', { className: 'relative' },
                                h('img', {
                                    src: expandedPhoto.large,
                                    alt: 'Expanded photo',
                                    className: 'max-w-[90vw] max-h-[90vh] object-contain',
                                    onClick: (e) => e.stopPropagation(),
                                    onError: (e) => {
                                        // Try medium size if large fails
                                        if (e.target.src !== expandedPhoto.medium) {
                                            e.target.src = expandedPhoto.medium;
                                        }
                                    }
                                }),
                                expandedPhoto.attribution && h('div', {
                                    className: 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white text-sm p-2'
                                }, expandedPhoto.attribution)
                            ),
                            h('button', {
                                onClick: () => setExpandedPhoto(null),
                                className: 'absolute top-4 right-4 text-white text-2xl hover:text-gray-300'
                            }, '‚úï')
                        )
                    )
                );
            }

            // Main Admin Portal Component with Enhanced Features
            function AdminPortal() {
                const [currentView, setCurrentView] = useState('dashboard');
                const [specimens, setSpecimens] = useState([]);
                const [specimenSubTab, setSpecimenSubTab] = useState('review');
                const [fieldGuides, setFieldGuides] = useState([]);
                const [modules, setModules] = useState([]);
                const [loadingModules, setLoadingModules] = useState(false);
                const [loading, setLoading] = useState(true);
                const [selectedSpecimen, setSelectedSpecimen] = useState(null);
                const [selectedSpecies, setSelectedSpecies] = useState(null);
                const [selectedModule, setSelectedModule] = useState(null);
                const [toast, setToast] = useState(null);
                const [searchTerm, setSearchTerm] = useState('');
                const [filterCategory, setFilterCategory] = useState('All');
                const [filterStatus, setFilterStatus] = useState('all');

                // Pagination state
                const [specimensPage, setSpecimensPage] = useState(1);
                const [specimensPerPage, setSpecimensPerPage] = useState(25);
                const [guidesPage, setGuidesPage] = useState(1);
                const [guidesPerPage, setGuidesPerPage] = useState(20);

                // Filter state
                const [specimensFilters, setSpecimensFilters] = useState({
                    status: 'all',
                    dnaSequenced: 'all',
                    family: 'all',
                    genus: 'all'
                });

                useEffect(() => {
                    loadAllSpecimens();
                }, []);

                // Load training modules when view changes
                useEffect(() => {
                    if (currentView === 'training-modules') {
                        loadTrainingModules();
                    }
                }, [currentView]);

                const loadAllSpecimens = async () => {
                    const allSpecimens = [];
                    const pageSize = 1000;
                    let offset = 0;
                    let hasMore = true;
                    
                    setLoading(true);
                    showToast('Loading specimens...', 'info');
                    
                    try {
                        while (hasMore) {
                            const response = await fetch(
                                `${SUPABASE_URL}/rest/v1/specimens?select=*&order=created_at.desc&limit=${pageSize}&offset=${offset}`,
                                {
                                    headers: {
                                        'apikey': SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                        'Prefer': 'count=exact'
                                    }
                                }
                            );
                            
                            if (!response.ok) throw new Error('Failed to load specimens');
                            
                            const data = await response.json();
                            allSpecimens.push(...data);
                            
                            const contentRange = response.headers.get('Content-Range');
                            if (contentRange) {
                                const match = contentRange.match(/\d+-\d+\/(\d+)/);
                                if (match) {
                                    const totalCount = parseInt(match[1]);
                                    offset += pageSize;
                                    hasMore = offset < totalCount;
                                    
                                    // Update progress
                                    showToast(`Loading: ${Math.min(offset, totalCount)}/${totalCount} specimens`, 'info');
                                }
                            } else {
                                hasMore = data.length === pageSize;
                                offset += pageSize;
                            }
                        }
                        
                        setSpecimens(allSpecimens);
                        showToast(`Loaded all ${allSpecimens.length} specimens`, 'success');
                        
                        // Load field guides
                        const guidesResponse = await fetch(
                            `${SUPABASE_URL}/rest/v1/field_guides?select=*`,
                            {
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                }
                            }
                        );
                        
                        if (guidesResponse.ok) {
                            const guidesData = await guidesResponse.json();
                            setFieldGuides(guidesData);
                        }
                        
                    } catch (error) {
                        console.error('Error:', error);
                        showToast('Failed to load all specimens', 'error');
                    } finally {
                        setLoading(false);
                    }
                };

                const loadTrainingModules = async () => {
                    if (loadingModules) return;
                    setLoadingModules(true);
                    
                    try {
                        console.log('üìö Loading training modules from database...');
                        
                        // Method 1: If using the API endpoint (recommended)
                        const response = await fetch('/api/training-modules', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const modules = await response.json();
                            setModules(modules || []);
                            console.log(`‚úÖ Loaded ${modules.length} modules`);
                        } else {
                            // Fallback to direct Supabase query
                            console.log('API failed, trying direct Supabase query...');
                            
                            const supabaseResponse = await fetch(
                                `${SUPABASE_URL}/rest/v1/training_modules?order=created_at.desc`,
                                {
                                    headers: {
                                        'apikey': SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                        'Accept': 'application/json'
                                    }
                                }
                            );
                            
                            if (supabaseResponse.ok) {
                                const data = await supabaseResponse.json();
                                setModules(data || []);
                                console.log(`‚úÖ Loaded ${data.length} modules via Supabase`);
                            } else {
                                const errorText = await supabaseResponse.text();
                                console.error('Supabase query failed:', errorText);
                                throw new Error('Failed to load modules from database');
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading modules:', error);
                        console.log('Falling back to ModuleLoader if available...');
                        
                        // Final fallback: Try ModuleLoader
                        if (window.ModuleLoader && window.ModuleLoader.getAllModules) {
                            try {
                                const allModules = await window.ModuleLoader.getAllModules();
                                console.log('‚úÖ Loaded modules via ModuleLoader:', allModules.length);
                                setModules(allModules || []);
                            } catch (loaderError) {
                                console.error('ModuleLoader also failed:', loaderError);
                                setModules([]);
                            }
                        } else {
                            console.warn('ModuleLoader not available');
                            setModules([]);
                        }
                    } finally {
                        setLoadingModules(false);
                    }
                };

                const showToast = (message, type = 'info') => {
                    setToast({ message, type });
                };

                const handleApproveSpecimen = async (notes, selectedPhotos) => {
                    try {
                        const response = await fetch(`${API_BASE}/admin`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                specimenId: selectedSpecimen.id,
                                status: 'approved',
                                notes: notes,
                                selectedPhotoIds: selectedPhotos
                            })
                        });

                        if (response.ok) {
                            showToast('Specimen approved successfully', 'success');
                            setSelectedSpecimen(null);
                            loadAllSpecimens();
                        } else {
                            showToast('Failed to approve specimen', 'error');
                        }
                    } catch (error) {
                        console.error('Error approving specimen:', error);
                        showToast('Error approving specimen', 'error');
                    }
                };

                const handleDeleteSpecimen = async () => {
                    if (!confirm(`Delete specimen "${selectedSpecimen.species_name}"?`)) return;
                    
                    try {
                        const response = await fetch(`${API_BASE}/admin`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ specimenId: selectedSpecimen.id })
                        });

                        if (response.ok) {
                            showToast('Specimen deleted successfully', 'success');
                            setSelectedSpecimen(null);
                            loadAllSpecimens();
                        } else {
                            showToast('Failed to delete specimen', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting specimen:', error);
                        showToast('Error deleting specimen', 'error');
                    }
                };

                const handleSaveFieldGuide = (fieldGuide) => {
                    showToast('Field guide saved successfully', 'success');
                    loadAllSpecimens();
                };

                // Get all photos for a species
                const getAllPhotosForSpecies = (speciesName) => {
                    const photos = [];
                    const speciesSpecimens = specimens.filter(s => s.species_name === speciesName);
                    
                    for (const specimen of speciesSpecimens) {
                        if (specimen.selected_photos && specimen.selected_photos.length > 0) {
                            specimen.selected_photos.forEach(photoId => {
                                photos.push({
                                    type: 'inaturalist',
                                    url: `https://inaturalist-open-data.s3.amazonaws.com/photos/${photoId}/medium.jpg`,
                                    inaturalist_id: specimen.inaturalist_id,
                                    source: `Specimen ${specimen.inaturalist_id}`
                                });
                            });
                        }
                    }
                    return photos;
                };

                // Calculate statistics
                const stats = useMemo(() => {
                    const total = specimens.length;
                    const pending = specimens.filter(s => s.status === 'pending').length;
                    const approved = specimens.filter(s => s.status === 'approved').length;
                    const dnaVerified = specimens.filter(s => s.dna_sequenced).length;
                    const uniqueSpecies = new Set(specimens.map(s => s.species_name)).size;
                    const guidesComplete = fieldGuides.length;
                    const moduleDuration = modules.reduce((sum, m) => sum + (m.duration_minutes || 0), 0);

                    return { total, pending, approved, dnaVerified, uniqueSpecies, guidesComplete, moduleDuration };
                }, [specimens, fieldGuides, modules]);

                // Get unique species list
                const uniqueSpeciesList = useMemo(() => {
                    const speciesMap = new Map();
                    specimens.forEach(s => {
                        if (!speciesMap.has(s.species_name)) {
                            speciesMap.set(s.species_name, {
                                species_name: s.species_name,
                                genus: s.genus,
                                family: s.family,
                                common_name: s.common_name,
                                specimens: []
                            });
                        }
                        speciesMap.get(s.species_name).specimens.push(s);
                    });
                    
                    return Array.from(speciesMap.values()).map(species => {
                        const guide = fieldGuides.find(g => g.species_name === species.species_name);
                        return { ...species, ...guide };
                    });
                }, [specimens, fieldGuides]);

                // Filter specimens
                const filteredSpecimens = useMemo(() => {
                    let filtered = [...specimens];
                    
                    if (searchTerm) {
                        filtered = filtered.filter(s => 
                            s.species_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            s.genus?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            s.family?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            s.common_name?.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                    }
                    
                    if (specimensFilters.status !== 'all') {
                        filtered = filtered.filter(s => s.status === specimensFilters.status);
                    }
                    
                    if (specimensFilters.dnaSequenced !== 'all') {
                        filtered = filtered.filter(s => s.dna_sequenced === (specimensFilters.dnaSequenced === 'yes'));
                    }
                    
                    if (specimensFilters.family !== 'all') {
                        filtered = filtered.filter(s => s.family === specimensFilters.family);
                    }
                    
                    if (specimensFilters.genus !== 'all') {
                        filtered = filtered.filter(s => s.genus === specimensFilters.genus);
                    }
                    
                    return filtered;
                }, [specimens, searchTerm, specimensFilters]);

                // Get filter options
                const filterOptions = useMemo(() => {
                    return {
                        families: [...new Set(specimens.map(s => s.family).filter(Boolean))].sort(),
                        genera: [...new Set(specimens.map(s => s.genus).filter(Boolean))].sort()
                    };
                }, [specimens]);

                // Pagination calculations
                const totalSpecimensPages = Math.ceil(filteredSpecimens.length / specimensPerPage);
                const paginatedSpecimens = filteredSpecimens.slice(
                    (specimensPage - 1) * specimensPerPage,
                    specimensPage * specimensPerPage
                );

                const totalGuidesPages = Math.ceil(uniqueSpeciesList.length / guidesPerPage);
                const paginatedGuides = uniqueSpeciesList
                    .filter(species => 
                        !searchTerm || 
                        species.species_name.toLowerCase().includes(searchTerm.toLowerCase())
                    )
                    .slice(
                        (guidesPage - 1) * guidesPerPage,
                        guidesPage * guidesPerPage
                    );

                if (loading) {
                    return h('div', { className: 'min-h-screen bg-[#0F1419] flex items-center justify-center' },
                        h('div', { className: 'text-center' },
                            h('div', { className: 'text-6xl mb-4 animate-pulse' }, 'üçÑ'),
                            h('h1', { className: 'text-2xl font-bold text-[#E2E8F0] mb-2' }, 'Loading Admin Portal'),
                            h('p', { className: 'text-[#94A3B8]' }, 'Fetching specimens and field guides...')
                        )
                    );
                }

                return h('div', { className: 'min-h-screen bg-[#0F1419]' },
                    // Header
                    h('div', { className: 'ocean-gradient text-[#E2E8F0] shadow-lg' },
                        h('div', { className: 'max-w-7xl mx-auto px-4 py-6' },
                            h('div', { className: 'flex justify-between items-center' },
                                h('div', { className: 'flex items-center gap-4' },
                                    h('div', { className: 'text-4xl' }, 'üçÑ'),
                                    h('div', null,
                                        h('div', { className: 'flex items-center gap-3' },
                                            h('h1', { className: 'text-2xl font-bold' }, 'Flash Fungi Admin')
                                        ),
                                        h('p', { className: 'text-[#B8DAF3] text-sm' }, 'Enhanced Management System with Training & Analytics')
                                    )
                                ),
                                h('div', { className: 'grid grid-cols-3 gap-6 text-center' },
                                    h('div', null,
                                        h('div', { className: 'text-3xl font-bold text-green-400' }, stats.approved),
                                        h('div', { className: 'text-xs text-[#B8DAF3]' }, 'Approved')
                                    ),
                                    h('div', null,
                                        h('div', { className: 'text-3xl font-bold text-orange-400' }, stats.pending),
                                        h('div', { className: 'text-xs text-[#B8DAF3]' }, 'Pending')
                                    ),
                                    h('div', null,
                                        h('div', { className: 'text-3xl font-bold text-blue-400' }, stats.guidesComplete),
                                        h('div', { className: 'text-xs text-[#B8DAF3]' }, 'Field Guides')
                                    )
                                )
                            )
                        )
                    ),

                    // Navigation Tabs
                    h('div', { className: 'card-dark border-b border-[#263244] shadow-sm sticky top-0 z-10' },
                        h('div', { className: 'max-w-7xl mx-auto px-4' },
                            h('div', { className: 'flex gap-6 overflow-x-auto' },
                                [
                                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                                    { id: 'specimens', label: 'Specimen Management', icon: 'üî¨', badge: stats.pending },
                                    { id: 'field-guides', label: 'Field Guides', icon: 'üìö', badge: stats.guidesComplete },
                                    { id: 'training-modules', label: 'Training Modules', icon: 'üéì', phase3: true },
                                    { id: 'achievements', label: 'Achievements', icon: 'üèÜ', phase3: true },
                                    { id: 'user-analytics', label: 'Analytics', icon: 'üìà', phase3: true },
                                ].map(item =>
                                    h('button', {
                                        key: item.id,
                                        onClick: () => setCurrentView(item.id),
                                        className: `flex items-center gap-2 px-4 py-4 border-b-2 transition-all whitespace-nowrap ${
                                            currentView === item.id 
                                                ? 'border-[#2563EB] text-[#60A5FA] bg-[#2563EB] bg-opacity-10' 
                                                : 'border-transparent text-[#94A3B8] hover:text-[#E2E8F0] hover:bg-[#263244]'
                                        }`
                                    },
                                        h('span', null, item.icon),
                                        item.label,
                                        item.phase3 && h('span', {
                                            className: 'ml-1 px-1.5 py-0.5 text-xs rounded-full bg-[#2563EB] bg-opacity-20 text-[#60A5FA]'
                                        }, 'NEW'),
                                        item.badge !== undefined && item.badge > 0 && h('span', {
                                            className: `ml-2 px-2 py-1 text-xs rounded-full ${
                                                currentView === item.id
                                                    ? 'bg-[#2563EB] text-[#E2E8F0]'
                                                    : 'bg-[#263244] text-[#94A3B8]'
                                            }`
                                        }, item.badge)
                                    )
                                )
                            )
                        )
                    ),

                    // Main Content
                    h('main', { className: 'max-w-7xl mx-auto px-4 py-8' },
                        // Dashboard View (Enhanced)
                        currentView === 'dashboard' && h('div', { className: 'space-y-6 fade-in' },
                            // Statistics Cards
                            h('div', { className: 'grid md:grid-cols-4 gap-6' },
                                [
                                    { title: 'Total Specimens', value: stats.total, color: 'blue', icon: 'üî¨', desc: 'In database' },
                                    { title: 'Unique Species', value: stats.uniqueSpecies, color: 'green', icon: 'üß¨', desc: 'Identified' },
                                    { title: 'Training Modules', value: modules.length, color: 'purple', icon: 'üìö', desc: `${stats.moduleDuration} minutes total` },
                                    { title: 'DNA Verified', value: stats.dnaVerified, color: 'pink', icon: 'üß¨', desc: 'Specimens' }
                                ].map(stat =>
                                    h('div', {
                                        key: stat.title,
                                        className: 'card-dark rounded-xl p-6 shadow-md hover:shadow-xl transition-all duration-300'
                                    },
                                        h('div', { className: 'flex justify-between items-start' },
                                            h('div', null,
                                                h('p', { className: 'text-sm text-[#94A3B8]' }, stat.title),
                                                h('p', { className: `text-3xl font-bold text-[#E2E8F0] mt-2` }, stat.value),
                                                h('p', { className: 'text-xs text-[#64748B] mt-1' }, stat.desc)
                                            ),
                                            h('div', { className: 'text-3xl opacity-20' }, stat.icon)
                                        )
                                    )
                                )
                            ),

                            // Recent Activity
                            h('div', { className: 'card-dark rounded-xl p-6 shadow-md' },
                                h('h3', { className: 'text-xl font-bold text-[#E2E8F0] mb-4' }, 'üìà Recent Activity'),
                                h('div', { className: 'space-y-3' },
                                    h('div', { className: 'flex justify-between items-center py-2 border-b border-[#263244]' },
                                        h('span', { className: 'text-[#94A3B8]' }, 'Specimens Approved Today'),
                                        h('span', { className: 'font-bold text-[#E2E8F0]' }, '0')
                                    ),
                                    h('div', { className: 'flex justify-between items-center py-2 border-b border-[#263244]' },
                                        h('span', { className: 'text-[#94A3B8]' }, 'Modules Completed'),
                                        h('span', { className: 'font-bold text-[#E2E8F0]' }, modules.length)
                                    ),
                                    h('div', { className: 'flex justify-between items-center py-2' },
                                        h('span', { className: 'text-[#94A3B8]' }, 'Active Users'),
                                        h('span', { className: 'font-bold text-green-400' }, 'Growing')
                                    )
                                )
                            ),

                            // Quick Actions
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('h3', { className: 'text-lg font-semibold mb-4 text-[#E2E8F0]' }, '‚ö° Quick Actions'),
                                h('div', { className: 'grid md:grid-cols-3 gap-4' },
                                    [
                                        { action: 'Manage Training Content', desc: 'Edit modules and lessons', view: 'training-modules', color: 'purple' },
                                        { action: 'Review User Progress', desc: 'Analytics and insights', view: 'user-analytics', color: 'blue' },
                                        { action: 'Configure Achievements', desc: 'Badges and milestones', view: 'achievements', color: 'yellow' }
                                    ].map((action, idx) =>
                                        h('button', {
                                            key: idx,
                                            onClick: () => setCurrentView(action.view),
                                            className: `text-left p-4 border border-[#263244] rounded-lg hover:shadow-md transition-all hover:bg-[#263244]`
                                        },
                                            h('div', { className: `font-medium text-[#60A5FA]` }, action.action),
                                            h('div', { className: 'text-sm text-[#94A3B8] mt-1' }, action.desc)
                                        )
                                    )
                                )
                            )
                        ),

                        // Training Modules Management View (COMPLETE)
                        currentView === 'training-modules' && h('div', null,
                            h('div', { className: 'mb-6' },
                                h('h2', { className: 'text-2xl font-bold mb-4 text-[#E2E8F0]' }, 'üéì Training Modules Management'),
                                
                                // Category Filter Buttons
                                h('div', { className: 'flex gap-2 mb-6 flex-wrap' },
                                    ['All', 'foundation', 'genus', 'advanced', 'regional'].map(cat =>
                                        h('button', {
                                            key: cat,
                                            onClick: () => setFilterCategory(cat),
                                            className: `px-4 py-2 rounded-lg font-medium transition-all ${
                                                filterCategory === cat 
                                                    ? 'ocean-gradient text-[#E2E8F0]' 
                                                    : 'bg-[#263244] text-[#94A3B8] hover:bg-[#334155]'
                                            }`
                                        }, cat.charAt(0).toUpperCase() + cat.slice(1))
                                    )
                                ),
                                
                                // Create New Module Button
                                h('button', {
                                    onClick: () => {
                                        const newModule = {
                                            id: null,
                                            title: '',
                                            category: 'foundation',
                                            difficulty_level: 'beginner',
                                            duration_minutes: 20,
                                            content: {
                                                introduction: { pages: [] },
                                                quiz: { questions: [] }
                                            },
                                            published: false
                                        };
                                        setSelectedModule(newModule);
                                    },
                                    className: 'px-4 py-2 sky-gradient text-[#E2E8F0] rounded-lg hover:opacity-90 transition-all mb-4'
                                }, '+ Create New Module')
                            ),
                            
                            // Loading State
                            loadingModules && h('div', { className: 'text-center py-8' },
                                h('div', { className: 'text-[#94A3B8]' }, 'Loading modules...')
                            ),
                            
                            // Modules Grid
                            !loadingModules && h('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' },
                                modules
                                    .filter(module => {
                                        if (filterCategory === 'All') {
                                            return true;
                                        }
                                        return module.category === filterCategory;
                                    })
                                    .map(module =>
                                        h('div', {
                                            key: module.id || module.title,
                                            className: 'card-dark rounded-lg shadow p-4 hover:shadow-md transition-shadow cursor-pointer',
                                            onClick: () => setSelectedModule(module)
                                        },
                                            h('div', { className: 'flex justify-between items-start mb-2' },
                                                h('h3', { className: 'font-bold text-lg text-[#E2E8F0]' }, module.title),
                                                h('span', {
                                                    className: `text-xs px-2 py-1 rounded ${
                                                        module.published 
                                                            ? 'bg-green-900 bg-opacity-50 text-green-400'
                                                            : 'bg-[#263244] text-[#94A3B8]'
                                                    }`
                                                }, module.published ? 'Published' : 'Draft')
                                            ),
                                            h('div', { className: 'space-y-1 text-sm text-[#94A3B8]' },
                                                h('p', null, module.description || 'No description'),
                                                h('p', null, `Category: ${module.category}`),
                                                h('p', null, `Difficulty: ${module.difficulty_level}`),
                                                h('p', null, `Duration: ${module.duration_minutes} minutes`),
                                                h('p', null, 
                                                    `Content: ${
                                                        Object.keys(module.content || {}).length
                                                    } sections`
                                                )
                                            ),
                                            h('div', { className: 'mt-3 flex gap-2' },
                                                h('button', {
                                                    onClick: (e) => {
                                                        e.stopPropagation();
                                                        setSelectedModule(module);
                                                    },
                                                    className: 'text-xs px-3 py-1 bg-[#2563EB] bg-opacity-20 text-[#60A5FA] rounded hover:bg-opacity-30 transition-all'
                                                }, 'Edit'),
                                                h('button', {
                                                    onClick: async (e) => {
                                                        e.stopPropagation();
                                                        if (confirm(`Delete module "${module.title}"?`)) {
                                                            try {
                                                                const response = await fetch(`/api/training-modules?id=${module.id}`, {
                                                                    method: 'DELETE'
                                                                });
                                                                if (response.ok) {
                                                                    showToast('Module deleted', 'success');
                                                                    loadTrainingModules();
                                                                }
                                                            } catch (error) {
                                                                showToast('Failed to delete module', 'error');
                                                            }
                                                        }
                                                    },
                                                    className: 'text-xs px-3 py-1 bg-red-900 bg-opacity-50 text-red-400 rounded hover:bg-opacity-70 transition-all'
                                                }, 'Delete'),
                                                h('button', {
                                                    onClick: async (e) => {
                                                        e.stopPropagation();
                                                        try {
                                                            const response = await fetch(`/api/training-modules?id=${module.id}`, {
                                                                method: 'PATCH',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ published: !module.published })
                                                            });
                                                            if (response.ok) {
                                                                showToast(
                                                                    module.published ? 'Module unpublished' : 'Module published',
                                                                    'success'
                                                                );
                                                                loadTrainingModules();
                                                            }
                                                        } catch (error) {
                                                            showToast('Failed to update module', 'error');
                                                        }
                                                    },
                                                    className: 'text-xs px-3 py-1 bg-purple-900 bg-opacity-50 text-purple-400 rounded hover:bg-opacity-70 transition-all'
                                                }, module.published ? 'Unpublish' : 'Publish')
                                            )
                                        )
                                    )
                            ),
                            
                            // Show message if no modules found
                            !loadingModules && modules.filter(m => filterCategory === 'All' || m.category === filterCategory).length === 0 && 
                                h('div', { className: 'text-center py-8 card-dark rounded-lg' },
                                    h('p', { className: 'text-[#94A3B8]' }, 
                                        filterCategory === 'All' 
                                            ? 'No training modules found. Create your first module!'
                                            : `No ${filterCategory} modules found.`
                                    )
                                )
                        ),

                        // Achievements System View (Placeholder)
                        currentView === 'achievements' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('div', { className: 'flex justify-between items-center mb-6' },
                                    h('div', null,
                                        h('div', { className: 'flex items-center gap-3 mb-2' },
                                            h('h2', { className: 'text-2xl font-bold text-[#E2E8F0]' }, 'Achievement System'),
                                            h(Phase3Badge)
                                        ),
                                        h('p', { className: 'text-[#94A3B8]' }, 
                                            'Manage badges, milestones, and user recognition'
                                        )
                                    )
                                ),
                                h('div', { className: 'text-center py-12' },
                                    h('div', { className: 'text-6xl mb-4' }, 'üèÜ'),
                                    h('h3', { className: 'text-xl font-semibold mb-2 text-[#E2E8F0]' }, 'Achievement System Coming Soon'),
                                    h('p', { className: 'text-[#94A3B8]' }, 'This feature will be available in the next update')
                                )
                            )
                        ),

                        // User Analytics Dashboard (Placeholder)
                        currentView === 'user-analytics' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('div', { className: 'flex justify-between items-center mb-6' },
                                    h('div', null,
                                        h('div', { className: 'flex items-center gap-3 mb-2' },
                                            h('h2', { className: 'text-2xl font-bold text-[#E2E8F0]' }, 'User Analytics Dashboard'),
                                            h(Phase3Badge)
                                        ),
                                        h('p', { className: 'text-[#94A3B8]' }, 
                                            'Learning progress and platform engagement insights'
                                        )
                                    )
                                ),
                                h('div', { className: 'text-center py-12' },
                                    h('div', { className: 'text-6xl mb-4' }, 'üìà'),
                                    h('h3', { className: 'text-xl font-semibold mb-2 text-[#E2E8F0]' }, 'Analytics Dashboard Coming Soon'),
                                    h('p', { className: 'text-[#94A3B8]' }, 'This feature will be available in the next update')
                                )
                            )
                        ),

                        // Field Guide Pages View with Enhanced Blue Theme
                        currentView === 'field-guides' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('div', { className: 'flex justify-between items-center mb-6' },
                                    h('div', null,
                                        h('h2', { className: 'text-2xl font-bold text-[#E2E8F0]' }, 'Field Guide Pages'),
                                        h('p', { className: 'text-[#94A3B8]' }, 
                                            `${stats.guidesComplete} of ${stats.uniqueSpecies} species have field guides`
                                        )
                                    ),
                                    h(AdvancedSearchBar, {
                                        value: searchTerm,
                                        onChange: setSearchTerm,
                                        placeholder: 'Search species...'
                                    })
                                ),

                                h('div', { className: 'grid gap-4' },
                                    paginatedGuides.map(species => {
                                        const hasGuide = species.hints && species.hints.length > 0;
                                        const specimenCount = species.specimens.length;
                                        const photoCount = species.reference_photos ? species.reference_photos.length : 0;
                                        
                                        return h('div', {
                                            key: species.species_name,
                                            className: `border rounded-lg p-4 transition-all ${
                                                hasGuide 
                                                    ? 'border-[#263244] bg-[#0F1419] hover:bg-[#1A2332]' 
                                                    : 'border-[#263244] bg-[#1A2332] bg-opacity-50'
                                            }`
                                        },
                                            h('div', { className: 'flex justify-between items-start' },
                                                h('div', { className: 'flex-1' },
                                                    h('h3', { className: 'text-lg font-semibold text-[#E2E8F0]' }, species.species_name),
                                                    h('p', { className: 'text-[#94A3B8]' }, 
                                                        species.common_name || `Family: ${species.family}`
                                                    ),
                                                    h('div', { className: 'flex items-center gap-4 mt-2' },
                                                        h('span', { className: 'text-sm text-[#64748B]' }, 
                                                            `${specimenCount} specimen${specimenCount !== 1 ? 's' : ''}`
                                                        ),
                                                        photoCount > 0 && h('span', { className: 'text-sm text-[#60A5FA]' }, 
                                                            `üì∏ ${photoCount} photos`
                                                        ),
                                                        hasGuide && h('span', { 
                                                            className: 'text-sm bg-green-900 bg-opacity-50 text-green-400 px-2 py-1 rounded'
                                                        }, '‚úì Has Guide')
                                                    )
                                                ),
                                                h('button', {
                                                    onClick: () => setSelectedSpecies(species),
                                                    className: `px-4 py-2 rounded-lg text-[#E2E8F0] transition-all ${
                                                        hasGuide 
                                                            ? 'teal-gradient hover:opacity-90' 
                                                            : 'sky-gradient hover:opacity-90'
                                                    }`
                                                }, hasGuide ? 'Edit Guide' : 'Create Guide')
                                            )
                                        );
                                    })
                                ),

                                // Pagination Controls
                                h(PaginationControls, {
                                    currentPage: guidesPage,
                                    totalPages: totalGuidesPages,
                                    onPageChange: setGuidesPage,
                                    itemsPerPage: guidesPerPage,
                                    totalItems: uniqueSpeciesList.filter(species => 
                                        !searchTerm || 
                                        species.species_name.toLowerCase().includes(searchTerm.toLowerCase())
                                    ).length,
                                    onItemsPerPageChange: (value) => {
                                        setGuidesPerPage(value);
                                        setGuidesPage(1);
                                    }
                                })
                            )
                        ),

                        // Specimen Management View with Enhanced Pagination
                        currentView === 'specimens' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                // Header with title
                                h('div', { className: 'mb-6' },
                                    h('h2', { className: 'text-2xl font-bold mb-2 text-[#E2E8F0]' }, 'üî¨ Specimen Management'),
                                    h('p', { className: 'text-[#94A3B8]' }, 
                                        `Total: ${stats.total} specimens | ${stats.pending} pending review | ${stats.approved} approved`
                                    )
                                ),
                                
                                // Search bar
                                h('div', { className: 'mb-6' },
                                    h(AdvancedSearchBar, {
                                        value: searchTerm,
                                        onChange: setSearchTerm,
                                        placeholder: 'Search specimens by species, location, family...',
                                        showAdvanced: true
                                    })
                                ),

                                // Filters
                                h(FilterPanel, {
                                    filters: specimensFilters,
                                    onFilterChange: setSpecimensFilters
                                },
                                    h('div', { className: 'grid md:grid-cols-4 gap-4' },
                                        h('div', null,
                                            h('label', { className: 'block text-sm font-medium text-[#94A3B8] mb-1' }, 'Status'),
                                            h('select', {
                                                value: specimensFilters.status,
                                                onChange: (e) => setSpecimensFilters(prev => ({ ...prev, status: e.target.value })),
                                                className: 'w-full px-3 py-2 rounded-lg text-[#E2E8F0] bg-[#0F1419] border border-[#263244]'
                                            },
                                                h('option', { value: 'all' }, 'All Status'),
                                                h('option', { value: 'pending' }, 'Pending'),
                                                h('option', { value: 'approved' }, 'Approved')
                                            )
                                        ),
                                        h('div', null,
                                            h('label', { className: 'block text-sm font-medium text-[#94A3B8] mb-1' }, 'DNA'),
                                            h('select', {
                                                value: specimensFilters.dnaSequenced,
                                                onChange: (e) => setSpecimensFilters(prev => ({ ...prev, dnaSequenced: e.target.value })),
                                                className: 'w-full px-3 py-2 rounded-lg text-[#E2E8F0] bg-[#0F1419] border border-[#263244]'
                                            },
                                                h('option', { value: 'all' }, 'All'),
                                                h('option', { value: 'yes' }, 'Yes'),
                                                h('option', { value: 'no' }, 'No')
                                            )
                                        ),
                                        h('div', null,
                                            h('label', { className: 'block text-sm font-medium text-[#94A3B8] mb-1' }, 'Family'),
                                            h('select', {
                                                value: specimensFilters.family,
                                                onChange: (e) => setSpecimensFilters(prev => ({ ...prev, family: e.target.value })),
                                                className: 'w-full px-3 py-2 rounded-lg text-[#E2E8F0] bg-[#0F1419] border border-[#263244]'
                                            },
                                                h('option', { value: 'all' }, 'All Families'),
                                                ...filterOptions.families.slice(0, 20).map(family =>
                                                    h('option', { key: family, value: family }, family)
                                                )
                                            )
                                        ),
                                        h('button', {
                                            onClick: () => setSpecimensFilters({
                                                status: 'all',
                                                dnaSequenced: 'all',
                                                family: 'all',
                                                genus: 'all'
                                            }),
                                            className: 'mt-6 text-sm text-[#60A5FA] hover:text-[#2563EB]'
                                        }, 'Clear filters')
                                    )
                                ),
                                
                                // Results table
                                h('div', { className: 'overflow-x-auto mt-6' },
                                    h('table', { className: 'w-full' },
                                        h('thead', { className: 'bg-[#0F1419]' },
                                            h('tr', null,
                                                h('th', { className: 'p-3 text-center text-[#94A3B8]' }, 'DNA'),
                                                h('th', { className: 'p-3 text-center text-[#94A3B8]' }, 'Photos'),
                                                h('th', { className: 'p-3 text-center text-[#94A3B8]' }, 'Status'),
                                                h('th', { className: 'p-3 text-center text-[#94A3B8]' }, 'Actions')
                                            )
                                        ),
                                        h('tbody', null,
                                            paginatedSpecimens.map(specimen =>
                                                h('tr', { 
                                                    key: specimen.id,
                                                    className: 'border-t border-[#263244] hover:bg-[#0F1419]'
                                                },
                                                    h('td', { className: 'p-3' },
                                                        h('div', null,
                                                            h('div', { className: 'font-medium text-[#E2E8F0]' }, specimen.species_name || 'Unknown'),
                                                            specimen.common_name && h('div', { className: 'text-sm text-[#64748B]' }, specimen.common_name)
                                                        )
                                                    ),
                                                    h('td', { className: 'p-3 text-[#94A3B8] text-sm' },
                                                        h('div', null,
                                                            h('div', null, specimen.family),
                                                            h('div', { className: 'text-xs text-[#64748B]' }, specimen.genus)
                                                        )
                                                    ),
                                                    h('td', { className: 'p-3 text-sm text-[#94A3B8]' }, specimen.location),
                                                    h('td', { className: 'p-3 text-center' },
                                                        specimen.dna_sequenced && h('span', { className: 'text-purple-400' }, 'üß¨')
                                                    ),
                                                    h('td', { className: 'p-3 text-center text-[#94A3B8]' },
                                                        specimen.selected_photos?.length || 0
                                                    ),
                                                    h('td', { className: 'p-3 text-center' },
                                                        h('span', {
                                                            className: `px-2 py-1 rounded text-xs font-medium ${
                                                                specimen.status === 'approved' 
                                                                    ? 'bg-green-900 bg-opacity-50 text-green-400' 
                                                                    : 'bg-yellow-900 bg-opacity-50 text-yellow-400'
                                                            }`
                                                        }, specimen.status || 'pending')
                                                    ),
                                                    h('td', { className: 'p-3 text-center' },
                                                        h('button', {
                                                            onClick: () => setSelectedSpecimen(specimen),
                                                            className: 'text-[#60A5FA] hover:text-[#2563EB] font-medium'
                                                        }, specimen.status === 'pending' ? 'Review' : 'View')
                                                    )
                                                )
                                            )
                                        )
                                    )
                                ),

                                // Pagination controls
                                h(PaginationControls, {
                                    currentPage: specimensPage,
                                    totalPages: totalSpecimensPages,
                                    onPageChange: setSpecimensPage,
                                    itemsPerPage: specimensPerPage,
                                    totalItems: filteredSpecimens.length,
                                    onItemsPerPageChange: (value) => {
                                        setSpecimensPerPage(value);
                                        setSpecimensPage(1);
                                    }
                                })
                            )
                        )
                    ),

                    // Modals
                    selectedSpecimen && h(SpecimenReviewModal, {
                        specimen: selectedSpecimen,
                        onClose: () => setSelectedSpecimen(null),
                        onApprove: handleApproveSpecimen,
                        onDelete: handleDeleteSpecimen
                    }),

                    selectedSpecies && h(FieldGuideEditor, {
                        species: selectedSpecies,
                        specimens: specimens,
                        allPhotos: getAllPhotosForSpecies(selectedSpecies.species_name),
                        onClose: () => setSelectedSpecies(null),
                        onSave: handleSaveFieldGuide
                    }),

                    selectedModule && h(ModuleEditor, {
                        module: selectedModule,
                        onClose: () => setSelectedModule(null),
                        onSave: (updatedModule) => {
                            showToast('Module saved successfully!', 'success');
                            setSelectedModule(null);
                            loadTrainingModules();
                        }
                    }),

                    // Toast Notifications
                    toast && h(Toast, {
                        message: toast.message,
                        type: toast.type,
                        onClose: () => setToast(null)
                    })
                );
            }

            // Render the app
            try {
                const root = ReactDOM.createRoot(document.getElementById('admin-root'));
                root.render(h(AdminPortal));
                console.log('‚úÖ Enhanced Admin portal with Blue Ocean theme initialized successfully');
            } catch (error) {
                console.error('‚ùå Error rendering admin portal:', error);
            }
        }
    </script>
</body>
</html>