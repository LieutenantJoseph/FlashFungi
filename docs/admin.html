<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Fungi - Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="/components/training/ModuleLoader.js"></script>
    <style>
        /* Living Mycology Dark Theme */
        body {
            background-color: #1A1A19;
        }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .skeleton { 
            background: linear-gradient(90deg, #2A2826 25%, #3A3836 50%, #2A2826 75%); 
            background-size: 200% 100%; 
            animation: loading 1.5s infinite; 
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Living Mycology Gradients */
        .earth-gradient { 
            background: linear-gradient(135deg, #8B4513 0%, #654321 100%); 
        }
        
        .forest-gradient {
            background: linear-gradient(135deg, #2D4A2B 0%, #1A2F1A 100%);
        }
        
        .moss-gradient {
            background: linear-gradient(135deg, #4A5D3A 0%, #2F3E27 100%);
        }
        
        /* Card styling */
        .card-dark {
            background-color: #2A2826;
            border: 1px solid #3A3836;
        }
        
        /* Button transitions */
        button {
            transition: all 0.3s ease;
        }
        
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1A1A19;
        }
        ::-webkit-scrollbar-thumb {
            background: #4A4846;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #5A5856;
        }
        
        /* Input styling for dark theme */
        input, textarea, select {
            background-color: #1A1A19;
            border: 1px solid #3A3836;
            color: #E8E6E3;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #8B4513;
            outline: none;
        }
        
        /* Modal backdrop blur */
        .modal-backdrop {
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body>
    <div id="admin-root">
        <div class="min-h-screen bg-[#1A1A19] flex items-center justify-center">
            <div class="text-center">
                <div class="text-6xl mb-4">üçÑ</div>
                <h1 class="text-2xl font-bold text-[#E8E6E3] mb-2">Admin Portal Loading...</h1>
                <p class="text-[#B8B6B3]">Initializing Phase 3 ready management system...</p>
            </div>
        </div>
    </div>

    <!-- Main Admin Portal Script -->
    <script>
        // Wait for React to load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeAdminPortal, 100);
        });

        function initializeAdminPortal() {
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                console.error('React libraries not loaded');
                return;
            }

            const { useState, useEffect, useCallback, useMemo } = React;
            const h = React.createElement;
            
            // Configuration
            const SUPABASE_URL = 'https://bhvozliqmcxzfotwuzjh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJodm96bGlxbWN4emZvdHd1empoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI3Mjk4ODAsImV4cCI6MjA0ODMwNTg4MH0.s8fM-r93UQvJre1OL0sJQiXqzQJxGMQZDnQMl4f5qQo';

            // Toast Component
            function Toast({ message, type = 'info', onClose }) {
                useEffect(() => {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }, [onClose]);

                const bgColor = {
                    success: 'forest-gradient',
                    error: 'bg-red-900',
                    warning: 'bg-yellow-900',
                    info: 'moss-gradient'
                }[type];

                return h('div', {
                    className: `fixed top-4 right-4 ${bgColor} text-[#E8E6E3] px-6 py-3 rounded-lg shadow-xl z-50 flex items-center gap-3`
                },
                    h('span', null, message),
                    h('button', {
                        onClick: onClose,
                        className: 'ml-2 hover:text-white transition-colors'
                    }, '√ó')
                );
            }

            // Phase3Badge Component
            function Phase3Badge({ label = 'Phase 3' }) {
                return h('span', { 
                    className: 'px-2 py-1 text-xs rounded-full bg-[#8B4513] bg-opacity-20 text-[#D2691E] border border-[#8B4513] border-opacity-30'
                }, label);
            }

            // Review Modal Component
            function ReviewModal({ specimen, photos, onClose, onApprove, onDelete }) {
                const [selectedPhotos, setSelectedPhotos] = useState([]);
                const [notes, setNotes] = useState('');

                return h('div', {
                    className: 'fixed inset-0 bg-black bg-opacity-75 modal-backdrop z-50 flex items-center justify-center p-4'
                },
                    h('div', {
                        className: 'card-dark rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl'
                    },
                        h('div', {
                            className: 'earth-gradient text-[#E8E6E3] p-6'
                        },
                            h('h2', { className: 'text-2xl font-bold mb-2' }, specimen.species_name),
                            h('p', { className: 'opacity-80' }, 
                                `iNaturalist: ${specimen.observation_id} ‚Ä¢ Status: ${specimen.status}`
                            )
                        ),
                        h('div', { className: 'p-6' },
                            // Photo Grid
                            h('div', { className: 'mb-6' },
                                h('h3', { className: 'text-lg font-semibold mb-3 text-[#E8E6E3]' }, 'üì∏ Photos'),
                                h('div', { className: 'grid grid-cols-3 gap-3' },
                                    photos.map(photo =>
                                        h('div', {
                                            key: photo.id,
                                            onClick: () => {
                                                setSelectedPhotos(prev =>
                                                    prev.includes(photo.id)
                                                        ? prev.filter(id => id !== photo.id)
                                                        : [...prev, photo.id]
                                                );
                                            },
                                            className: `relative cursor-pointer rounded-lg overflow-hidden transition-all duration-300 ${
                                                selectedPhotos.includes(photo.id)
                                                    ? 'ring-4 ring-[#8B4513] scale-105'
                                                    : 'hover:ring-2 hover:ring-[#654321]'
                                            }`
                                        },
                                            h('img', {
                                                src: photo.url,
                                                alt: photo.attribution,
                                                className: 'w-full h-32 object-cover'
                                            }),
                                            selectedPhotos.includes(photo.id) && h('div', {
                                                className: 'absolute top-2 right-2 bg-[#8B4513] text-white rounded-full w-6 h-6 flex items-center justify-center'
                                            }, '‚úì')
                                        )
                                    )
                                )
                            ),

                            // Notes Section
                            h('div', { className: 'mb-6' },
                                h('h3', { className: 'text-lg font-semibold mb-3 text-[#E8E6E3]' }, 'üìù Admin Notes'),
                                h('textarea', {
                                    value: notes,
                                    onChange: (e) => setNotes(e.target.value),
                                    placeholder: 'Add notes about this specimen...',
                                    className: 'w-full px-3 py-2 rounded-lg text-[#E8E6E3]',
                                    rows: 3
                                })
                            ),

                            // Action Buttons
                            h('div', { className: 'flex gap-3' },
                                specimen.status === 'pending' && [
                                    h('button', {
                                        key: 'delete',
                                        onClick: () => onDelete(),
                                        className: 'px-6 py-2 bg-red-900 text-[#E8E6E3] rounded-lg hover:bg-red-800 transition-all duration-300'
                                    }, 'üóëÔ∏è Delete'),
                                    h('button', {
                                        key: 'approve',
                                        onClick: () => onApprove(notes, selectedPhotos),
                                        className: 'px-6 py-2 forest-gradient text-[#E8E6E3] rounded-lg hover:opacity-90 transition-all duration-300'
                                    }, '‚úÖ Approve')
                                ],
                                h('button', {
                                    onClick: onClose,
                                    className: 'px-6 py-2 border border-[#3A3836] text-[#B8B6B3] rounded-lg hover:bg-[#3A3836] transition-all duration-300'
                                }, 'Close')
                            )
                        )
                    )
                );
            }

            // Main Admin Portal Component
            function AdminPortal() {
                const [currentView, setCurrentView] = useState('dashboard');
                const [specimens, setSpecimens] = useState([]);
                const [fieldGuides, setFieldGuides] = useState([]);
                const [modules, setModules] = useState([]);
                const [loadingModules, setLoadingModules] = useState(false);
                const [loading, setLoading] = useState(true);
                const [selectedSpecimen, setSelectedSpecimen] = useState(null);
                const [selectedSpecies, setSelectedSpecies] = useState(null);
                const [selectedModule, setSelectedModule] = useState(null);
                const [toast, setToast] = useState(null);
                const [searchTerm, setSearchTerm] = useState('');
                const [filterCategory, setFilterCategory] = useState('All');
                const [filterStatus, setFilterStatus] = useState('all');

                // Calculate stats
                const stats = useMemo(() => ({
                    approved: specimens.filter(s => s.status === 'approved').length,
                    pending: specimens.filter(s => s.status === 'pending').length,
                    guidesComplete: fieldGuides.filter(g => g.diagnostic_features).length,
                    modules: modules.length,
                    moduleDuration: modules.reduce((sum, m) => sum + (m.duration_minutes || 0), 0)
                }), [specimens, fieldGuides, modules]);

                // Data fetching functions
                const loadSpecimens = useCallback(async () => {
                    try {
                        console.log('Loading specimens...');
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/specimens?select=*&order=created_at.desc`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        const data = await response.json();
                        console.log('Specimens loaded:', data.length);
                        setSpecimens(data || []);
                    } catch (error) {
                        console.error('Error loading specimens:', error);
                        setSpecimens([]);
                    }
                }, []);

                const loadFieldGuides = useCallback(async () => {
                    try {
                        console.log('Loading field guides...');
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/field_guides?select=*`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        const data = await response.json();
                        console.log('Field guides loaded:', data.length);
                        setFieldGuides(data || []);
                    } catch (error) {
                        console.error('Error loading field guides:', error);
                        setFieldGuides([]);
                    }
                }, []);

                const loadTrainingModules = useCallback(async () => {
                    if (loadingModules) return;
                    setLoadingModules(true);
                    
                    try {
                        console.log('Loading training modules...');
                        if (window.ModuleLoader && window.ModuleLoader.getAllModules) {
                            const allModules = await window.ModuleLoader.getAllModules();
                            console.log('Training modules loaded:', allModules.length);
                            setModules(allModules || []);
                        } else {
                            console.warn('ModuleLoader not available or getAllModules function missing');
                            setModules([]);
                        }
                    } catch (error) {
                        console.error('Error loading training modules:', error);
                        setModules([]);
                    } finally {
                        setLoadingModules(false);
                    }
                }, [loadingModules]);

                // Initial load
                useEffect(() => {
                    Promise.all([
                        loadSpecimens(),
                        loadFieldGuides(),
                        loadTrainingModules()
                    ]).then(() => setLoading(false))
                    .catch(error => {
                        console.error('Error during initial load:', error);
                        setLoading(false);
                    });
                }, []);

                // Specimen management functions
                const handleApproveSpecimen = async (specimenId, notes, selectedPhotos) => {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/specimens?id=eq.${specimenId}`, {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                status: 'approved',
                                admin_notes: notes,
                                selected_photos: selectedPhotos
                            })
                        });
                        
                        if (response.ok) {
                            setToast({ message: 'Specimen approved successfully', type: 'success' });
                            loadSpecimens();
                            setSelectedSpecimen(null);
                        }
                    } catch (error) {
                        console.error('Error approving specimen:', error);
                        setToast({ message: 'Error approving specimen', type: 'error' });
                    }
                };

                const handleDeleteSpecimen = async (specimenId) => {
                    if (!confirm('Are you sure you want to delete this specimen?')) return;
                    
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/specimens?id=eq.${specimenId}`, {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        
                        if (response.ok) {
                            setToast({ message: 'Specimen deleted', type: 'success' });
                            loadSpecimens();
                            setSelectedSpecimen(null);
                        }
                    } catch (error) {
                        console.error('Error deleting specimen:', error);
                        setToast({ message: 'Error deleting specimen', type: 'error' });
                    }
                };

                // Field guide edit modal
                const FieldGuideEditModal = ({ species, guides, onClose, onSave }) => {
                    const [fieldGuide, setFieldGuide] = useState(() => {
                        const existing = guides.find(g => g.species === species);
                        return existing || {
                            species: species,
                            common_names: [],
                            diagnostic_features: {
                                cap: {},
                                hymenium: {},
                                stem: {},
                                spore_print: {}
                            },
                            habitat: {},
                            ecology: {},
                            lookalikes: []
                        };
                    });

                    const updateDiagnostic = (category, field, value) => {
                        setFieldGuide(prev => ({
                            ...prev,
                            diagnostic_features: {
                                ...prev.diagnostic_features,
                                [category]: {
                                    ...prev.diagnostic_features[category],
                                    [field]: value
                                }
                            }
                        }));
                    };

                    const handleSave = async () => {
                        try {
                            const method = guides.find(g => g.species === species) ? 'PATCH' : 'POST';
                            const url = method === 'PATCH'
                                ? `${SUPABASE_URL}/rest/v1/field_guides?species=eq.${encodeURIComponent(species)}`
                                : `${SUPABASE_URL}/rest/v1/field_guides`;
                                
                            const response = await fetch(url, {
                                method,
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(fieldGuide)
                            });
                            
                            if (response.ok) {
                                onSave();
                            }
                        } catch (error) {
                            console.error('Error saving field guide:', error);
                        }
                    };

                    return h('div', {
                        className: 'fixed inset-0 bg-black bg-opacity-75 modal-backdrop z-50 flex items-center justify-center p-4'
                    },
                        h('div', {
                            className: 'card-dark rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl'
                        },
                            h('div', {
                                className: 'earth-gradient text-[#E8E6E3] p-6 sticky top-0 z-10'
                            },
                                h('h2', { className: 'text-2xl font-bold' }, `Field Guide: ${species}`)
                            ),
                            h('div', { className: 'p-6 space-y-6' },
                                // Common Names
                                h('div', { className: 'bg-[#1A1A19] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E8E6E3]' }, 'üè∑Ô∏è Common Names'),
                                    h('input', {
                                        type: 'text',
                                        value: fieldGuide.common_names.join(', '),
                                        onChange: (e) => setFieldGuide(prev => ({
                                            ...prev,
                                            common_names: e.target.value.split(',').map(n => n.trim())
                                        })),
                                        placeholder: 'Enter common names separated by commas',
                                        className: 'w-full px-3 py-2 rounded-lg text-[#E8E6E3]'
                                    })
                                ),

                                // Cap Features
                                h('div', { className: 'bg-[#1A1A19] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E8E6E3]' }, 'üçÑ Cap Features'),
                                    h('div', { className: 'grid grid-cols-3 gap-3' },
                                        ['color', 'shape', 'texture'].map(field =>
                                            h('div', { key: field },
                                                h('label', { className: 'block text-sm font-medium text-[#B8B6B3] mb-1 capitalize' }, 
                                                    field
                                                ),
                                                h('input', {
                                                    type: 'text',
                                                    value: fieldGuide.diagnostic_features.cap[field] || '',
                                                    onChange: (e) => updateDiagnostic('cap', field, e.target.value),
                                                    className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E8E6E3]'
                                                })
                                            )
                                        )
                                    )
                                ),

                                // Hymenium Features
                                h('div', { className: 'bg-[#1A1A19] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E8E6E3]' }, 'üìä Hymenium Features'),
                                    h('div', { className: 'grid grid-cols-3 gap-3' },
                                        ['type', 'attachment', 'spacing'].map(field =>
                                            h('div', { key: field },
                                                h('label', { className: 'block text-sm font-medium text-[#B8B6B3] mb-1 capitalize' }, 
                                                    field
                                                ),
                                                h('input', {
                                                    type: 'text',
                                                    value: fieldGuide.diagnostic_features.hymenium[field] || '',
                                                    onChange: (e) => updateDiagnostic('hymenium', field, e.target.value),
                                                    placeholder: field === 'type' ? 'gills/pores/teeth' : '',
                                                    className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E8E6E3]'
                                                })
                                            )
                                        )
                                    )
                                ),

                                // Stem Features
                                h('div', { className: 'bg-[#1A1A19] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E8E6E3]' }, 'ü¶¥ Stem Features'),
                                    h('div', { className: 'grid grid-cols-3 gap-3' },
                                        ['ring_presence', 'base_structure', 'texture'].map(field =>
                                            h('div', { key: field },
                                                h('label', { className: 'block text-sm font-medium text-[#B8B6B3] mb-1 capitalize' }, 
                                                    field.replace('_', ' ')
                                                ),
                                                h('input', {
                                                    type: 'text',
                                                    value: fieldGuide.diagnostic_features.stem[field],
                                                    onChange: (e) => updateDiagnostic('stem', field, e.target.value),
                                                    className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E8E6E3]'
                                                })
                                            )
                                        )
                                    )
                                ),

                                // Spore Print
                                h('div', { className: 'bg-[#1A1A19] rounded-lg p-4' },
                                    h('h4', { className: 'font-medium mb-3 text-[#E8E6E3]' }, 'üé® Spore Print'),
                                    h('div', { className: 'grid grid-cols-2 gap-3' },
                                        h('div', null,
                                            h('label', { className: 'block text-sm font-medium text-[#B8B6B3] mb-1' }, 'Color'),
                                            h('input', {
                                                type: 'text',
                                                value: fieldGuide.diagnostic_features.spore_print.color,
                                                onChange: (e) => updateDiagnostic('spore_print', 'color', e.target.value),
                                                className: 'w-full px-3 py-2 rounded-lg text-sm text-[#E8E6E3]'
                                            })
                                        )
                                    )
                                ),

                                // Save button
                                h('div', { className: 'flex justify-end gap-3 pt-4' },
                                    h('button', {
                                        onClick: onClose,
                                        className: 'px-6 py-2 border border-[#3A3836] text-[#B8B6B3] rounded-lg hover:bg-[#3A3836] transition-all duration-300'
                                    }, 'Cancel'),
                                    h('button', {
                                        onClick: handleSave,
                                        className: 'px-6 py-2 forest-gradient text-[#E8E6E3] rounded-lg hover:opacity-90 transition-all duration-300'
                                    }, 'Save Field Guide')
                                )
                            )
                        )
                    );
                };

                // Module edit modal
                const ModuleEditModal = ({ module, onClose, onSave }) => {
                    const [editedModule, setEditedModule] = useState(module || {
                        category: 'foundation',
                        title: '',
                        description: '',
                        introduction: [],
                        quiz_questions: []
                    });

                    const handleUpdatePage = (section, idx, field, value) => {
                        setEditedModule(prev => ({
                            ...prev,
                            [section]: prev[section].map((item, i) => 
                                i === idx ? { ...item, [field]: value } : item
                            )
                        }));
                    };

                    const handleAddPage = (section) => {
                        setEditedModule(prev => ({
                            ...prev,
                            [section]: [...prev[section], section === 'quiz_questions' 
                                ? { question: '', answers: [], correct_answer: 0 }
                                : { title: '', content: '', image: '' }
                            ]
                        }));
                    };

                    const handleDeletePage = (section, idx) => {
                        setEditedModule(prev => ({
                            ...prev,
                            [section]: prev[section].filter((_, i) => i !== idx)
                        }));
                    };

                    return h('div', {
                        className: 'fixed inset-0 bg-black bg-opacity-75 modal-backdrop z-50 flex items-center justify-center p-4'
                    },
                        h('div', {
                            className: 'card-dark rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl'
                        },
                            h('div', {
                                className: 'earth-gradient text-[#E8E6E3] p-6 sticky top-0 z-10'
                            },
                                h('h2', { className: 'text-2xl font-bold' }, 
                                    module ? `Edit: ${module.title}` : 'New Training Module'
                                )
                            ),
                            h('div', { className: 'p-6 space-y-6' },
                                // Module basics
                                h('div', { className: 'space-y-3' },
                                    h('input', {
                                        type: 'text',
                                        value: editedModule.title,
                                        onChange: (e) => setEditedModule(prev => ({ ...prev, title: e.target.value })),
                                        placeholder: 'Module title',
                                        className: 'w-full px-3 py-2 rounded-lg text-[#E8E6E3]'
                                    }),
                                    h('textarea', {
                                        value: editedModule.description,
                                        onChange: (e) => setEditedModule(prev => ({ ...prev, description: e.target.value })),
                                        placeholder: 'Module description',
                                        className: 'w-full px-3 py-2 rounded-lg text-[#E8E6E3]',
                                        rows: 3
                                    })
                                ),

                                // Introduction pages
                                h('div', { className: 'bg-[#1A1A19] rounded-lg p-4' },
                                    h('div', { className: 'flex justify-between items-center mb-3' },
                                        h('h3', { className: 'font-medium text-[#E8E6E3]' }, 'Introduction Pages'),
                                        h('button', {
                                            onClick: () => handleAddPage('introduction'),
                                            className: 'px-3 py-1 moss-gradient text-[#E8E6E3] rounded hover:opacity-90 transition-all duration-300 text-sm'
                                        }, '+ Add Page')
                                    ),
                                    h('div', { className: 'space-y-3' },
                                        editedModule.introduction.map((page, idx) =>
                                            h('div', {
                                                key: idx,
                                                className: 'bg-[#2A2826] p-3 rounded-lg'
                                            },
                                                h('div', { className: 'flex justify-between items-start mb-2' },
                                                    h('span', { className: 'text-sm font-medium text-[#B8B6B3]' }, 
                                                        `Page ${idx + 1}`
                                                    ),
                                                    h('button', {
                                                        onClick: () => handleDeletePage('introduction', idx),
                                                        className: 'text-red-400 hover:text-red-300 text-sm transition-colors'
                                                    }, 'Delete')
                                                ),
                                                h('input', {
                                                    type: 'text',
                                                    value: page.title || '',
                                                    onChange: (e) => handleUpdatePage('introduction', idx, 'title', e.target.value),
                                                    placeholder: 'Page title...',
                                                    className: 'w-full px-3 py-2 rounded text-sm mb-2 text-[#E8E6E3]'
                                                }),
                                                h('textarea', {
                                                    value: page.content || '',
                                                    onChange: (e) => handleUpdatePage('introduction', idx, 'content', e.target.value),
                                                    placeholder: 'Page content...',
                                                    className: 'w-full px-3 py-2 rounded text-sm text-[#E8E6E3]',
                                                    rows: 4
                                                }),
                                                h('input', {
                                                    type: 'text',
                                                    value: page.image || '',
                                                    onChange: (e) => handleUpdatePage('introduction', idx, 'image', e.target.value),
                                                    placeholder: 'Image URL (optional)...',
                                                    className: 'w-full px-3 py-2 rounded text-sm mt-2 text-[#E8E6E3]'
                                                })
                                            )
                                        )
                                    )
                                ),

                                // Save buttons
                                h('div', { className: 'flex justify-end gap-3 pt-4' },
                                    h('button', {
                                        onClick: onClose,
                                        className: 'px-6 py-2 border border-[#3A3836] text-[#B8B6B3] rounded-lg hover:bg-[#3A3836] transition-all duration-300'
                                    }, 'Cancel'),
                                    h('button', {
                                        onClick: () => onSave(editedModule),
                                        className: 'px-6 py-2 forest-gradient text-[#E8E6E3] rounded-lg hover:opacity-90 transition-all duration-300'
                                    }, 'Save Module')
                                )
                            )
                        )
                    );
                };

                // Filtered specimens
                const filteredSpecimens = useMemo(() => {
                    let filtered = specimens;
                    
                    if (searchTerm) {
                        filtered = filtered.filter(s => 
                            s.species_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            s.genus?.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                    }
                    
                    if (filterStatus !== 'all') {
                        filtered = filtered.filter(s => s.status === filterStatus);
                    }
                    
                    return filtered;
                }, [specimens, searchTerm, filterStatus]);

                if (loading) {
                    return h('div', { className: 'min-h-screen bg-[#1A1A19] flex items-center justify-center' },
                        h('div', { className: 'text-center' },
                            h('div', { className: 'text-6xl mb-4 animate-pulse' }, 'üçÑ'),
                            h('h1', { className: 'text-2xl font-bold text-[#E8E6E3] mb-2' }, 'Loading Admin Portal'),
                            h('p', { className: 'text-[#B8B6B3]' }, 'Fetching specimens and field guides...')
                        )
                    );
                }

                return h('div', { className: 'min-h-screen bg-[#1A1A19]' },
                    // Enhanced Header with Phase 3 Indicator
                    h('div', { className: 'earth-gradient text-[#E8E6E3] shadow-lg' },
                        h('div', { className: 'max-w-7xl mx-auto px-4 py-6' },
                            h('div', { className: 'flex justify-between items-center' },
                                h('div', { className: 'flex items-center gap-4' },
                                    h('div', { className: 'text-4xl' }, 'üçÑ'),
                                    h('div', null,
                                        h('div', { className: 'flex items-center gap-3' },
                                            h('h1', { className: 'text-2xl font-bold' }, 'Flash Fungi Admin'),
                                            h(Phase3Badge, { label: 'Phase 3 Ready' })
                                        ),
                                        h('p', { className: 'text-[#D4D2CF] text-sm' }, 'Enhanced Management System with Training & Analytics')
                                    )
                                ),
                                h('div', { className: 'grid grid-cols-3 gap-6 text-center' },
                                    h('div', null,
                                        h('div', { className: 'text-3xl font-bold text-green-400' }, stats.approved),
                                        h('div', { className: 'text-xs text-[#D4D2CF]' }, 'Approved')
                                    ),
                                    h('div', null,
                                        h('div', { className: 'text-3xl font-bold text-orange-400' }, stats.pending),
                                        h('div', { className: 'text-xs text-[#D4D2CF]' }, 'Pending')
                                    ),
                                    h('div', null,
                                        h('div', { className: 'text-3xl font-bold text-blue-400' }, stats.guidesComplete),
                                        h('div', { className: 'text-xs text-[#D4D2CF]' }, 'Field Guides')
                                    )
                                )
                            )
                        )
                    ),

                    // Enhanced Navigation with Phase 3 Features
                    h('div', { className: 'card-dark border-b border-[#3A3836] shadow-sm sticky top-0 z-10' },
                        h('div', { className: 'max-w-7xl mx-auto px-4' },
                            h('div', { className: 'flex gap-6 overflow-x-auto' },
                                [
                                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                                    { id: 'review', label: 'Review Queue', icon: '‚è≥', badge: stats.pending },
                                    { id: 'field-guides', label: 'Field Guides', icon: 'üìö', badge: stats.guidesComplete },
                                    { id: 'training-modules', label: 'Training Modules', icon: 'üéì', phase3: true },
                                    { id: 'achievements', label: 'Achievements', icon: 'üèÜ', phase3: true },
                                    { id: 'user-analytics', label: 'Analytics', icon: 'üìà', phase3: true },
                                    { id: 'specimens', label: 'All Specimens', icon: 'üî¨' }
                                ].map(item =>
                                    h('button', {
                                        key: item.id,
                                        onClick: () => setCurrentView(item.id),
                                        className: `flex items-center gap-2 px-4 py-4 border-b-2 transition-all duration-300 whitespace-nowrap ${
                                            currentView === item.id 
                                                ? 'border-[#8B4513] text-[#D2691E] bg-[#8B4513] bg-opacity-10' 
                                                : 'border-transparent text-[#B8B6B3] hover:text-[#E8E6E3] hover:bg-[#3A3836]'
                                        }`
                                    },
                                        h('span', null, item.icon),
                                        item.label,
                                        item.phase3 && h('span', {
                                            className: 'ml-1 px-1.5 py-0.5 text-xs rounded-full bg-[#8B4513] bg-opacity-20 text-[#D2691E]'
                                        }, 'NEW'),
                                        item.badge !== undefined && item.badge > 0 && h('span', {
                                            className: `ml-2 px-2 py-1 text-xs rounded-full ${
                                                currentView === item.id
                                                    ? 'bg-[#8B4513] text-[#E8E6E3]'
                                                    : 'bg-[#3A3836] text-[#B8B6B3]'
                                            }`
                                        }, item.badge)
                                    )
                                )
                            )
                        )
                    ),

                    // Main Content with Phase 3 Features
                    h('main', { className: 'max-w-7xl mx-auto px-4 py-8' },
                        // Dashboard View (Enhanced)
                        currentView === 'dashboard' && h('div', { className: 'space-y-6 fade-in' },
                            // Phase 3 Features Overview
                            h('div', { 
                                className: 'moss-gradient text-[#E8E6E3] rounded-xl p-6 mb-6 shadow-lg'
                            },
                                h('div', { className: 'flex justify-between items-center' },
                                    h('div', null,
                                        h('h2', { className: 'text-2xl font-bold mb-2' }, 'üöÄ Phase 3 Enhancement Complete'),
                                        h('p', { className: 'opacity-90' }, 'Training modules, achievements, and analytics are now available!')
                                    ),
                                    h('div', { className: 'text-5xl opacity-20' }, 'üéì')
                                )
                            ),

                            // Stats Grid
                            h('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6' },
                                [
                                    { title: 'Total Specimens', value: specimens.length, icon: 'üî¨', desc: 'In database' },
                                    { title: 'Training Modules', value: modules.length, icon: 'üìö', desc: `${stats.moduleDuration} minutes total` },
                                    { title: 'Field Guides', value: stats.guidesComplete, icon: 'üìñ', desc: 'Complete guides' }
                                ].map((stat, idx) =>
                                    h('div', { 
                                        key: idx,
                                        className: 'card-dark rounded-xl p-6 shadow-md hover:shadow-xl transition-all duration-300'
                                    },
                                        h('div', { className: 'flex justify-between items-start' },
                                            h('div', null,
                                                h('div', { className: 'text-[#B8B6B3] text-sm mb-1' }, stat.title),
                                                h('div', { className: 'text-3xl font-bold text-[#E8E6E3] mb-2' }, stat.value),
                                                h('div', { className: 'text-[#8A8886] text-xs' }, stat.desc)
                                            ),
                                            h('div', { className: 'text-3xl opacity-50' }, stat.icon)
                                        )
                                    )
                                )
                            ),

                            // Recent Activity (Phase 3 Addition)
                            h('div', { className: 'card-dark rounded-xl p-6 shadow-md' },
                                h('h3', { className: 'text-xl font-bold text-[#E8E6E3] mb-4' }, 'üìà Recent Activity'),
                                h('div', { className: 'space-y-3' },
                                    h('div', { className: 'flex justify-between items-center py-2 border-b border-[#3A3836]' },
                                        h('span', { className: 'text-[#B8B6B3]' }, 'Specimens Approved Today'),
                                        h('span', { className: 'font-bold text-[#E8E6E3]' }, '0')
                                    ),
                                    h('div', { className: 'flex justify-between items-center py-2 border-b border-[#3A3836]' },
                                        h('span', { className: 'text-[#B8B6B3]' }, 'Modules Completed'),
                                        h('span', { className: 'font-bold text-[#E8E6E3]' }, modules.length)
                                    ),
                                    h('div', { className: 'flex justify-between items-center py-2' },
                                        h('span', { className: 'text-[#B8B6B3]' }, 'Active Users'),
                                        h('span', { className: 'font-bold text-green-400' }, 'Growing')
                                    )
                                )
                            )
                        ),

                        // Training Modules View (Phase 3 Feature)
                        currentView === 'training-modules' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('div', { className: 'flex justify-between items-center mb-6' },
                                    h('h2', { className: 'text-2xl font-bold text-[#E8E6E3]' }, 'üéì Training Modules'),
                                    h('button', {
                                        onClick: () => setSelectedModule({}),
                                        className: 'px-4 py-2 forest-gradient text-[#E8E6E3] rounded-lg hover:opacity-90 transition-all duration-300'
                                    }, '+ New Module')
                                ),
                                
                                // Module Stats
                                h('div', { className: 'grid grid-cols-3 gap-4 mb-6' },
                                    h('div', { className: 'bg-[#1A1A19] rounded-lg p-4 text-center' },
                                        h('div', { className: 'text-2xl font-bold text-[#8B4513]' }, modules.length),
                                        h('div', { className: 'text-sm text-[#B8B6B3]' }, 'Total Modules')
                                    ),
                                    h('div', { className: 'bg-[#1A1A19] rounded-lg p-4 text-center' },
                                        h('div', { className: 'text-2xl font-bold text-green-500' }, 
                                            modules.filter(m => m.category === 'foundation').length
                                        ),
                                        h('div', { className: 'text-sm text-[#B8B6B3]' }, 'Foundation')
                                    ),
                                    h('div', { className: 'bg-[#1A1A19] rounded-lg p-4 text-center' },
                                        h('div', { className: 'text-2xl font-bold text-purple-400' }, 
                                            modules.reduce((sum, m) => sum + (m.duration_minutes || 0), 0)
                                        ),
                                        h('div', { className: 'text-sm text-[#B8B6B3]' }, 'Total Minutes')
                                    )
                                ),
                                
                                // Module List
                                loadingModules ?
                                    h('div', { className: 'text-center py-8' },
                                        h('div', { className: 'text-[#B8B6B3]' }, 'Loading modules...')
                                    ) :
                                    modules.length === 0 ?
                                        h('div', { className: 'text-center py-8 text-[#B8B6B3]' },
                                            'No training modules found. Click "+ New Module" to create one.'
                                        ) :
                                        h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                                            modules.map(module =>
                                                h('div', {
                                                    key: module.id || module.title,
                                                    className: 'bg-[#1A1A19] border border-[#3A3836] rounded-lg p-4 hover:bg-[#2A2826] transition-all duration-300'
                                                },
                                                    h('div', { className: 'flex justify-between items-start' },
                                                        h('div', null,
                                                            h('h4', { className: 'font-semibold text-[#E8E6E3]' }, module.title),
                                                            h('p', { className: 'text-sm text-[#B8B6B3] mt-1' }, module.description),
                                                            h('div', { className: 'flex gap-2 mt-2' },
                                                                h('span', { 
                                                                    className: 'px-2 py-1 bg-[#3A3836] text-[#B8B6B3] rounded text-xs' 
                                                                }, module.category),
                                                                module.duration_minutes && h('span', { 
                                                                    className: 'px-2 py-1 bg-[#3A3836] text-[#B8B6B3] rounded text-xs' 
                                                                }, `${module.duration_minutes} min`)
                                                            )
                                                        ),
                                                        h('button', {
                                                            onClick: () => setSelectedModule(module),
                                                            className: 'text-[#D2691E] hover:text-[#8B4513] transition-colors'
                                                        }, 'Edit')
                                                    )
                                                )
                                            )
                                        )
                            )
                        ),

                        // Achievements System View (Placeholder)
                        currentView === 'achievements' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('div', { className: 'flex justify-between items-center mb-6' },
                                    h('div', null,
                                        h('div', { className: 'flex items-center gap-3 mb-2' },
                                            h('h2', { className: 'text-2xl font-bold text-[#E8E6E3]' }, 'Achievement System'),
                                            h(Phase3Badge)
                                        ),
                                        h('p', { className: 'text-[#B8B6B3]' }, 
                                            'Manage badges, milestones, and user recognition'
                                        )
                                    )
                                ),
                                h('div', { className: 'text-center py-12' },
                                    h('div', { className: 'text-6xl mb-4' }, 'üèÜ'),
                                    h('h3', { className: 'text-xl font-semibold mb-2 text-[#E8E6E3]' }, 'Achievement System Coming Soon'),
                                    h('p', { className: 'text-[#B8B6B3]' }, 'This feature will be available in the next update')
                                )
                            )
                        ),

                        // User Analytics Dashboard (Placeholder)
                        currentView === 'user-analytics' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('div', { className: 'flex justify-between items-center mb-6' },
                                    h('div', null,
                                        h('div', { className: 'flex items-center gap-3 mb-2' },
                                            h('h2', { className: 'text-2xl font-bold text-[#E8E6E3]' }, 'User Analytics Dashboard'),
                                            h(Phase3Badge)
                                        ),
                                        h('p', { className: 'text-[#B8B6B3]' }, 
                                            'Learning progress and platform engagement insights'
                                        )
                                    )
                                ),
                                h('div', { className: 'text-center py-12' },
                                    h('div', { className: 'text-6xl mb-4' }, 'üìà'),
                                    h('h3', { className: 'text-xl font-semibold mb-2 text-[#E8E6E3]' }, 'Analytics Dashboard Coming Soon'),
                                    h('p', { className: 'text-[#B8B6B3]' }, 'This feature will be available in the next update')
                                )
                            )
                        ),

                        // Review Queue (Existing functionality preserved)
                        currentView === 'review' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('h2', { className: 'text-2xl font-bold mb-6 text-[#E8E6E3]' }, 'Review Queue'),
                                stats.pending === 0 ?
                                    h('div', { className: 'text-center py-12' },
                                        h('div', { className: 'text-6xl mb-4' }, 'üéâ'),
                                        h('h3', { className: 'text-2xl font-bold mb-2 text-[#E8E6E3]' }, 'All Caught Up!'),
                                        h('p', { className: 'text-[#B8B6B3]' }, 'No specimens pending review.')
                                    ) :
                                    h('div', { className: 'space-y-4' },
                                        specimens
                                            .filter(s => s.status === 'pending')
                                            .map(specimen =>
                                                h('div', {
                                                    key: specimen.id,
                                                    className: 'bg-[#1A1A19] border border-[#3A3836] rounded-lg p-4 hover:bg-[#2A2826] cursor-pointer transition-all duration-300',
                                                    onClick: () => setSelectedSpecimen(specimen)
                                                },
                                                    h('div', { className: 'flex justify-between' },
                                                        h('div', null,
                                                            h('h4', { className: 'font-semibold text-[#E8E6E3]' }, specimen.species_name),
                                                            h('p', { className: 'text-sm text-[#B8B6B3]' },
                                                                `Observation: ${specimen.observation_id}`
                                                            )
                                                        ),
                                                        h('button', {
                                                            className: 'px-4 py-2 moss-gradient text-[#E8E6E3] rounded hover:opacity-90 transition-all duration-300'
                                                        }, 'Review')
                                                    )
                                                )
                                            )
                                    )
                            )
                        ),

                        // Field Guides (Existing functionality preserved)
                        currentView === 'field-guides' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('h2', { className: 'text-2xl font-bold mb-6 text-[#E8E6E3]' }, 'Field Guides'),
                                specimens.length === 0 ?
                                    h('div', { className: 'text-center py-8' },
                                        h('p', { className: 'text-[#B8B6B3]' }, 'No specimens available. Add specimens to create field guides.')
                                    ) :
                                    h('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' },
                                        [...new Set(specimens.map(s => s.species_name).filter(Boolean))].sort().map(species =>
                                            h('div', {
                                                key: species,
                                                className: 'bg-[#1A1A19] border border-[#3A3836] rounded-lg p-4 hover:bg-[#2A2826] cursor-pointer transition-all duration-300',
                                                onClick: () => setSelectedSpecies(species)
                                            },
                                                h('h4', { className: 'font-semibold text-[#E8E6E3]' }, species),
                                                fieldGuides.find(g => g.species === species) ?
                                                    h('span', { className: 'text-green-400 text-sm' }, '‚úì Guide exists') :
                                                    h('span', { className: 'text-[#8A8886] text-sm' }, 'No guide yet')
                                            )
                                        )
                                    )
                            )
                        ),

                        // All Specimens (Existing functionality preserved)
                        currentView === 'specimens' && h('div', { className: 'space-y-6 fade-in' },
                            h('div', { className: 'card-dark rounded-xl shadow-md p-6' },
                                h('h2', { className: 'text-2xl font-bold mb-6 text-[#E8E6E3]' }, 'All Specimens'),
                                h('div', { className: 'mb-4 flex gap-4' },
                                    h('input', {
                                        type: 'text',
                                        placeholder: 'Search specimens...',
                                        value: searchTerm,
                                        onChange: (e) => setSearchTerm(e.target.value),
                                        className: 'flex-1 px-3 py-2 rounded-lg text-[#E8E6E3]'
                                    }),
                                    h('select', {
                                        value: filterStatus,
                                        onChange: (e) => setFilterStatus(e.target.value),
                                        className: 'px-3 py-2 rounded-lg text-[#E8E6E3]'
                                    },
                                        h('option', { value: 'all' }, 'All Status'),
                                        h('option', { value: 'approved' }, 'Approved'),
                                        h('option', { value: 'pending' }, 'Pending')
                                    )
                                ),
                                h('div', { className: 'overflow-x-auto' },
                                    h('table', { className: 'w-full' },
                                        h('thead', null,
                                            h('tr', { className: 'border-b border-[#3A3836]' },
                                                h('th', { className: 'text-left p-2 text-[#B8B6B3]' }, 'Species'),
                                                h('th', { className: 'text-left p-2 text-[#B8B6B3]' }, 'Observation'),
                                                h('th', { className: 'text-left p-2 text-[#B8B6B3]' }, 'Status'),
                                                h('th', { className: 'text-left p-2 text-[#B8B6B3]' }, 'Actions')
                                            )
                                        ),
                                        h('tbody', null,
                                            filteredSpecimens.map(specimen =>
                                                h('tr', { 
                                                    key: specimen.id,
                                                    className: 'border-b border-[#3A3836] hover:bg-[#1A1A19] transition-colors' 
                                                },
                                                    h('td', { className: 'p-2 text-[#E8E6E3]' }, specimen.species_name),
                                                    h('td', { className: 'p-2 text-[#E8E6E3]' }, specimen.observation_id),
                                                    h('td', { className: 'p-2' },
                                                        h('span', {
                                                            className: `px-2 py-1 rounded text-xs ${
                                                                specimen.status === 'approved' 
                                                                    ? 'bg-green-900 text-green-300' 
                                                                    : 'bg-yellow-900 text-yellow-300'
                                                            }`
                                                        }, specimen.status)
                                                    ),
                                                    h('td', { className: 'p-2' },
                                                        h('button', {
                                                            onClick: () => setSelectedSpecimen(specimen),
                                                            className: 'text-[#D2691E] hover:text-[#8B4513] transition-colors'
                                                        }, 'View')
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    // Modals
                    selectedSpecimen && h(ReviewModal, {
                        specimen: selectedSpecimen,
                        photos: [],
                        onClose: () => setSelectedSpecimen(null),
                        onApprove: (notes, photos) => handleApproveSpecimen(selectedSpecimen.id, notes, photos),
                        onDelete: () => handleDeleteSpecimen(selectedSpecimen.id)
                    }),

                    selectedSpecies && h(FieldGuideEditModal, {
                        species: selectedSpecies,
                        guides: fieldGuides,
                        onClose: () => setSelectedSpecies(null),
                        onSave: () => {
                            setToast({ message: 'Field guide saved', type: 'success' });
                            setSelectedSpecies(null);
                            loadFieldGuides();
                        }
                    }),

                    selectedModule && h(ModuleEditModal, {
                        module: selectedModule,
                        onClose: () => setSelectedModule(null),
                        onSave: (module) => {
                            setToast({ message: 'Module saved', type: 'success' });
                            setSelectedModule(null);
                            loadTrainingModules();
                        }
                    }),

                    // Toast Notifications
                    toast && h(Toast, {
                        message: toast.message,
                        type: toast.type,
                        onClose: () => setToast(null)
                    })
                );
            }

            // Render the app
            try {
                const root = ReactDOM.createRoot(document.getElementById('admin-root'));
                root.render(h(AdminPortal));
                console.log('‚úÖ Enhanced Admin portal with Phase 3 features initialized successfully');
            } catch (error) {
                console.error('‚ùå Error rendering admin portal:', error);
            }
        }
    </script>
</body>
</html>