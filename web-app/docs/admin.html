<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arizona Mushroom Study - Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="admin-root">
        <div style="padding: 20px; text-align: center;">
            <h1>Loading Admin Portal...</h1>
            <p>Please wait while the application loads.</p>
        </div>
    </div>

    <!-- Load React from a reliable CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        // Wait for DOM and React to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Give React a moment to load
            setTimeout(function() {
                initializeApp();
            }, 100);
        });

        function initializeApp() {
            console.log('Checking React availability...');
            console.log('React:', typeof React);
            console.log('ReactDOM:', typeof ReactDOM);
            
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                console.error('React libraries not available');
                document.getElementById('admin-root').innerHTML = `
                    <div style="padding: 20px; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; margin: 20px;">
                        <h2 style="color: #dc2626; margin: 0 0 10px 0;">React Libraries Not Loaded</h2>
                        <p style="color: #7f1d1d; margin: 0;">This may be due to network restrictions in the preview environment.</p>
                        <p style="color: #7f1d1d; margin: 10px 0 0 0;"><strong>Try:</strong> Opening this in a new tab or deploying to Vercel for full functionality.</p>
                    </div>
                `;
                return;
            }

            console.log('✅ React libraries loaded successfully');
            
            // Initialize the app
            const { useState, useEffect } = React;
            const h = React.createElement;
            
            // Configuration
            const SUPABASE_URL = 'https://oxgedcncrettasrbmwsl.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94Z2VkY25jcmV0dGFzcmJtd3NsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MDY4NjQsImV4cCI6MjA2OTQ4Mjg2NH0.mu0Cb6qRr4cja0vsSzIuLwDTtNFuimWUwNs_JbnO3Pg';

            // Simple Status Badge Component
            function StatusBadge({ status }) {
                const isApproved = status === 'approved';
                const className = isApproved 
                    ? 'inline-block px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800'
                    : 'inline-block px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800';
                const label = isApproved ? 'Approved' : 'Pending Review';
                
                return h('span', { className }, label);
            }

            // Simple Stat Card Component
            function StatCard({ title, value, color }) {
                return h('div', { className: 'bg-white rounded-xl p-6 shadow-sm' },
                    h('div', null,
                        h('p', { className: 'text-sm text-gray-600' }, title),
                        h('p', { className: `text-2xl font-bold ${color || 'text-blue-600'}` }, value || 0)
                    )
                );
            }

            // Simple Specimen Card Component
            function SpecimenCard({ specimen, onReview, showReviewButton }) {
                return h('div', { className: 'bg-white rounded-xl shadow-sm p-6 mb-4' },
                    h('div', { className: 'flex justify-between items-start mb-4' },
                        h('div', null,
                            h('h3', { className: 'text-lg font-semibold' }, specimen.species_name),
                            h('p', { className: 'text-gray-600' }, specimen.common_name || 'No common name'),
                            h('p', { className: 'text-sm text-gray-500' }, specimen.location)
                        ),
                        h('div', { className: 'flex items-center gap-2' },
                            h(StatusBadge, { status: specimen.status }),
                            specimen.dna_sequenced && h('span', {
                                className: 'bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium'
                            }, 'DNA Verified'),
                            showReviewButton && h('button', {
                                onClick: onReview,
                                className: 'bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors'
                            }, 'Review')
                        )
                    ),
                    h('div', { className: 'text-xs text-gray-500' },
                        'Added: ', new Date(specimen.created_at).toLocaleDateString()
                    )
                );
            }

            // Dashboard Component
            function Dashboard({ stats, specimens, speciesHints }) {
                const recentSpecimens = specimens.slice(0, 5);
                const uniqueSpecies = new Set(specimens.map(s => s.species_name));
                const speciesWithHints = new Set(speciesHints.map(h => h.species_name));
                const hintsCompleteness = uniqueSpecies.size > 0 ? Math.round((speciesWithHints.size / uniqueSpecies.size) * 100) : 0;

                return h('div', { className: 'space-y-6' },
                    h('div', { className: 'grid md:grid-cols-4 gap-6' },
                        h(StatCard, { title: 'Total Specimens', value: stats.total, color: 'text-blue-600' }),
                        h(StatCard, { title: 'Pending Review', value: stats.pending, color: 'text-orange-600' }),
                        h(StatCard, { title: 'Approved & Ready', value: stats.approved, color: 'text-green-600' }),
                        h(StatCard, { title: 'Hints Coverage', value: `${hintsCompleteness}%`, color: 'text-indigo-600' })
                    ),
                    
                    h('div', { className: 'bg-white rounded-xl p-6 shadow-sm' },
                        h('h3', { className: 'text-lg font-semibold mb-4' }, 'Recent Specimens'),
                        h('div', { className: 'space-y-3' },
                            recentSpecimens.length > 0 ? recentSpecimens.map(specimen =>
                                h('div', {
                                    key: specimen.id,
                                    className: 'flex items-center justify-between p-3 bg-gray-50 rounded-lg'
                                },
                                    h('div', null,
                                        h('h4', { className: 'font-medium' }, specimen.species_name),
                                        h('p', { className: 'text-sm text-gray-600' }, specimen.location)
                                    ),
                                    h('div', { className: 'flex items-center gap-2' },
                                        h(StatusBadge, { status: specimen.status }),
                                        specimen.dna_sequenced && h('span', {
                                            className: 'text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded'
                                        }, 'DNA'),
                                        speciesWithHints.has(specimen.species_name) && h('span', {
                                            className: 'text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded'
                                        }, 'Hints')
                                    )
                                )
                            ) : h('p', { className: 'text-gray-500 text-center py-4' }, 'No specimens yet')
                        )
                    )
                );
            }

            // Review Queue Component
            function ReviewQueue({ specimens, onSelectSpecimen }) {
                if (specimens.length === 0) {
                    return h('div', { className: 'text-center py-12' },
                        h('div', { className: 'text-6xl mb-4' }, '🎉'),
                        h('h3', { className: 'text-2xl font-bold mb-2' }, 'All Caught Up!'),
                        h('p', { className: 'text-gray-600' }, 'No specimens pending review.')
                    );
                }

                return h('div', { className: 'space-y-4' },
                    h('div', { className: 'flex justify-between items-center' },
                        h('h2', { className: 'text-2xl font-bold' }, 'Review Queue'),
                        h('p', { className: 'text-gray-600' }, `${specimens.length} specimens pending`)
                    ),
                    h('div', { className: 'grid gap-6' },
                        specimens.map(specimen =>
                            h(SpecimenCard, {
                                key: specimen.id,
                                specimen,
                                onReview: () => onSelectSpecimen(specimen),
                                showReviewButton: true
                            })
                        )
                    )
                );
            }

            // Simple Species Hints Management
            function SpeciesHintsManagement({ speciesHints, specimens }) {
                const allSpecies = [...new Set(specimens.map(s => s.species_name))].sort();
                const speciesWithHints = new Set(speciesHints.map(h => h.species_name));

                return h('div', { className: 'space-y-6' },
                    h('div', { className: 'flex justify-between items-center' },
                        h('h2', { className: 'text-2xl font-bold' }, 'Species Hints Management'),
                        h('p', { className: 'text-gray-600' }, `${speciesWithHints.size}/${allSpecies.length} species have hints`)
                    ),
                    
                    h('div', { className: 'grid gap-4' },
                        allSpecies.map(species => {
                            const hints = speciesHints.find(h => h.species_name === species);
                            const specimenCount = specimens.filter(s => s.species_name === species).length;
                            
                            return h('div', {
                                key: species,
                                className: 'bg-white rounded-xl p-4 shadow-sm'
                            },
                                h('div', { className: 'flex justify-between items-start' },
                                    h('div', { className: 'flex-1' },
                                        h('h3', { className: 'font-semibold text-lg' }, species),
                                        h('p', { className: 'text-sm text-gray-600' }, `${specimenCount} specimens`),
                                        hints && h('p', { className: 'text-xs text-gray-500 mt-1' },
                                            `${hints.hints?.length || 0} hints available`
                                        )
                                    ),
                                    h('div', { className: 'flex items-center gap-2' },
                                        hints ? h('span', {
                                            className: 'bg-green-100 text-green-800 px-2 py-1 rounded text-xs'
                                        }, '✓ Has Hints') : h('span', {
                                            className: 'bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs'
                                        }, '⚠ Missing Hints'),
                                        h('button', {
                                            onClick: () => alert('Advanced hint management features will be available when deployed to Vercel with the full API endpoints.'),
                                            className: 'bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-sm'
                                        }, hints ? 'Edit' : 'Create')
                                    )
                                )
                            );
                        })
                    )
                );
            }

            // Simple Specimen Review Modal
            function SpecimenReviewModal({ specimen, onClose, onApprove, onDelete }) {
                const [notes, setNotes] = useState(specimen.admin_notes || '');

                return h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50' },
                    h('div', { className: 'bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto' },
                        h('div', { className: 'p-6 border-b' },
                            h('div', { className: 'flex justify-between items-center' },
                                h('h2', { className: 'text-xl font-bold' }, `Review: ${specimen.species_name}`),
                                h('button', {
                                    onClick: onClose,
                                    className: 'text-gray-500 hover:text-gray-700 text-2xl'
                                }, '×')
                            )
                        ),

                        h('div', { className: 'p-6 space-y-6' },
                            h('div', { className: 'grid md:grid-cols-2 gap-6' },
                                h('div', null,
                                    h('h3', { className: 'font-semibold mb-3' }, 'Specimen Details'),
                                    h('div', { className: 'space-y-2 text-sm' },
                                        h('div', null, h('strong', null, 'Species: '), specimen.species_name),
                                        h('div', null, h('strong', null, 'Family: '), specimen.family),
                                        h('div', null, h('strong', null, 'Location: '), specimen.location),
                                        h('div', null, h('strong', null, 'DNA Verified: '), specimen.dna_sequenced ? 'Yes' : 'No')
                                    )
                                ),
                                h('div', null,
                                    h('h3', { className: 'font-semibold mb-3' }, 'Collection Info'),
                                    h('div', { className: 'space-y-2 text-sm' },
                                        h('div', null, h('strong', null, 'Habitat: '), specimen.habitat || 'Not specified'),
                                        h('div', null, h('strong', null, 'Quality Score: '), `${((specimen.quality_score || 0) * 100).toFixed(0)}%`),
                                        h('div', null,
                                            h('strong', null, 'iNaturalist: '),
                                            h('a', {
                                                href: `https://www.inaturalist.org/observations/${specimen.inaturalist_id}`,
                                                target: '_blank',
                                                className: 'text-blue-500 hover:text-blue-700'
                                            }, `${specimen.inaturalist_id} ↗`)
                                        )
                                    )
                                )
                            ),

                            h('div', null,
                                h('h3', { className: 'font-semibold mb-3' }, 'Admin Notes'),
                                h('textarea', {
                                    value: notes,
                                    onChange: (e) => setNotes(e.target.value),
                                    placeholder: 'Add notes about this specimen...',
                                    className: 'w-full p-3 border rounded-lg resize-none',
                                    rows: 3
                                })
                            ),

                            h('div', { className: 'flex gap-4 pt-4 border-t' },
                                specimen.status === 'pending' ? [
                                    h('button', {
                                        key: 'approve',
                                        onClick: () => onApprove(notes),
                                        className: 'bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg'
                                    }, '✅ Approve Specimen'),
                                    h('button', {
                                        key: 'delete',
                                        onClick: onDelete,
                                        className: 'bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg'
                                    }, '🗑️ Delete Specimen')
                                ] : h('button', {
                                    onClick: () => onApprove(notes),
                                    className: 'bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg'
                                }, '💾 Update Notes'),
                                h('button', {
                                    onClick: onClose,
                                    className: 'bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg'
                                }, 'Close')
                            )
                        )
                    )
                );
            }

            // Navigation Component
            function AdminNavigation({ currentView, setCurrentView }) {
                const navItems = [
                    { id: 'dashboard', label: 'Dashboard', icon: '📊' },
                    { id: 'review', label: 'Review Queue', icon: '⏳' },
                    { id: 'species-hints', label: 'Species Hints', icon: '🧬' },
                    { id: 'approved', label: 'Approved', icon: '✅' }
                ];

                return h('div', { className: 'bg-white border-b shadow-sm' },
                    h('div', { className: 'max-w-7xl mx-auto px-4' },
                        h('div', { className: 'flex gap-6' },
                            navItems.map(item =>
                                h('button', {
                                    key: item.id,
                                    onClick: () => setCurrentView(item.id),
                                    className: `flex items-center gap-2 px-4 py-4 border-b-2 transition-colors ${
                                        currentView === item.id 
                                            ? 'border-green-500 text-green-600' 
                                            : 'border-transparent text-gray-600 hover:text-gray-800'
                                    }`
                                },
                                    h('span', null, item.icon),
                                    item.label
                                )
                            )
                        )
                    )
                );
            }

            // Header Component
            function AdminHeader({ stats }) {
                return h('div', { className: 'bg-slate-800 text-white' },
                    h('div', { className: 'max-w-7xl mx-auto px-4 py-4' },
                        h('div', { className: 'flex justify-between items-center' },
                            h('div', { className: 'flex items-center gap-3' },
                                h('div', { className: 'text-3xl' }, '🛡️'),
                                h('div', null,
                                    h('h1', { className: 'text-xl font-bold' }, 'Admin Portal'),
                                    h('p', { className: 'text-slate-300 text-sm' }, 'Arizona Mushroom Study')
                                )
                            ),
                            h('div', { className: 'flex items-center gap-6' },
                                h('div', { className: 'text-center' },
                                    h('div', { className: 'text-2xl font-bold text-orange-400' }, stats.pending || 0),
                                    h('div', { className: 'text-xs text-slate-300' }, 'Pending')
                                ),
                                h('div', { className: 'text-center' },
                                    h('div', { className: 'text-2xl font-bold text-green-400' }, stats.approved || 0),
                                    h('div', { className: 'text-xs text-slate-300' }, 'Approved')
                                ),
                                h('div', { className: 'text-center' },
                                    h('div', { className: 'text-2xl font-bold text-blue-400' }, stats.dnaVerified || 0),
                                    h('div', { className: 'text-xs text-slate-300' }, 'DNA Verified')
                                )
                            )
                        )
                    )
                );
            }

            // Main App Component
            function AdminPortal() {
                const [currentView, setCurrentView] = useState('dashboard');
                const [specimens, setSpecimens] = useState([]);
                const [speciesHints, setSpeciesHints] = useState([]);
                const [loading, setLoading] = useState(true);
                const [stats, setStats] = useState({});
                const [selectedSpecimen, setSelectedSpecimen] = useState(null);

                useEffect(() => {
                    loadData();
                }, []);

                const loadData = async () => {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/specimens?select=*&order=created_at.desc`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            setSpecimens(data || []);
                            
                            const pending = data.filter(s => s.status === 'pending').length;
                            const approved = data.filter(s => s.status === 'approved').length;
                            const dnaVerified = data.filter(s => s.dna_sequenced).length;
                            
                            setStats({
                                total: data.length,
                                pending,
                                approved,
                                dnaVerified
                            });
                        }

                        // Load species hints
                        try {
                            const hintsResponse = await fetch(`${SUPABASE_URL}/rest/v1/species_hints?select=*`, {
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                }
                            });
                            if (hintsResponse.ok) {
                                const hintsData = await hintsResponse.json();
                                setSpeciesHints(hintsData || []);
                            }
                        } catch (error) {
                            console.log('Species hints not available');
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                const handleApprove = async (notes) => {
                    alert('Specimen approval functionality requires deployment to Vercel with API endpoints. In preview mode, this is a demo.');
                };

                const handleDelete = async () => {
                    if (!confirm(`Delete specimen "${selectedSpecimen.species_name}"?`)) return;
                    alert('Specimen deletion functionality requires deployment to Vercel with API endpoints. In preview mode, this is a demo.');
                };

                if (loading) {
                    return h('div', { className: 'min-h-screen bg-gray-50 flex items-center justify-center' },
                        h('div', { className: 'text-center' },
                            h('div', { className: 'text-6xl mb-4' }, '🛡️'),
                            h('h1', { className: 'text-2xl font-bold text-gray-800 mb-2' }, 'Admin Portal'),
                            h('p', { className: 'text-gray-600' }, 'Loading data...')
                        )
                    );
                }

                return h('div', { className: 'min-h-screen bg-gray-50' },
                    h(AdminHeader, { stats }),
                    h(AdminNavigation, { currentView, setCurrentView }),
                    h('main', { className: 'max-w-7xl mx-auto px-4 py-8' },
                        currentView === 'dashboard' && h(Dashboard, { stats, specimens, speciesHints }),
                        currentView === 'review' && h(ReviewQueue, { 
                            specimens: specimens.filter(s => s.status === 'pending'),
                            onSelectSpecimen: setSelectedSpecimen
                        }),
                        currentView === 'species-hints' && h(SpeciesHintsManagement, { speciesHints, specimens }),
                        currentView === 'approved' && h(ReviewQueue, { 
                            specimens: specimens.filter(s => s.status === 'approved'),
                            onSelectSpecimen: setSelectedSpecimen
                        })
                    ),
                    
                    selectedSpecimen && h(SpecimenReviewModal, {
                        specimen: selectedSpecimen,
                        onClose: () => setSelectedSpecimen(null),
                        onApprove: handleApprove,
                        onDelete: handleDelete
                    })
                );
            }

            // Render the app with error handling
            try {
                const root = ReactDOM.createRoot(document.getElementById('admin-root'));
                root.render(h(AdminPortal));
                console.log('✅ Admin portal rendered successfully');
            } catch (error) {
                console.error('❌ Error rendering admin portal:', error);
                document.getElementById('admin-root').innerHTML = `
                    <div style="padding: 20px; color: red; text-align: center;">
                        <h1>Rendering Error</h1>
                        <p>Error: ${error.message}</p>
                        <p>Please check the console for more details.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>